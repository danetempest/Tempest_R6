<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>R6 Coach Pro: Tactical Simulator</title>
    <style>
        :root { 
            --p-blue: #00d4ff; 
            --p-gold: #ffcc00; 
            --p-red: #ff4b4b; 
            --p-green: #00ff88;
            --p-purple: #a855f7;
            --bg: #09090b; 
            --card: #18181b;
            --floor: #1a1a1f;
            --wall: #0f0f12;
            --cover: #2a2a32;
        }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); 
            color: #fff; 
            font-family: 'Inter', -apple-system, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            margin: 0;
            min-height: 100vh;
        }
        
        .lab-card { 
            background: var(--card); 
            padding: 30px; 
            border-radius: 24px; 
            border: 1px solid #27272a; 
            width: 900px; 
            box-shadow: 0 50px 100px rgba(0,0,0,0.9); 
            position: relative; 
            margin-top: 40px; 
        }
        
        .back-link { 
            position: absolute; top: 20px; left: 20px; 
            color: #666; text-decoration: none; font-weight: bold; 
            display: flex; align-items: center; gap: 8px; 
            transition: 0.2s; z-index: 100;
        }
        .back-link:hover { color: var(--p-blue); }

        .rank-badge { 
            position: absolute; top: 25px; right: 40px; 
            font-size: 5rem; font-weight: 900; line-height: 1; 
            color: #27272a; transition: 0.3s; z-index: 100;
        }
        .rank-S { color: var(--p-gold); text-shadow: 0 0 40px var(--p-gold); }
        .rank-A { color: var(--p-blue); text-shadow: 0 0 20px var(--p-blue); }
        .rank-F { color: var(--p-red); }

        /* 3D VIEWPORT */
        .viewport { 
            height: 320px; 
            background: linear-gradient(180deg, #050508 0%, #0a0a0f 100%);
            border-radius: 16px; margin: 15px 0; position: relative; 
            overflow: hidden; border: 4px solid #27272a;
            perspective: 1200px; perspective-origin: 50% 60%;
        }
        .viewport.shake { animation: screenShake 0.15s ease-out; }
        .viewport.death-flash { animation: deathFlash 0.5s ease-out; }
        .viewport.beat-flash { animation: beatFlash 0.1s ease-out; }
        
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px) rotate(-0.5deg); }
            75% { transform: translateX(-4px); }
        }
        @keyframes deathFlash {
            0% { border-color: #ff0000; box-shadow: inset 0 0 100px rgba(255,0,0,0.8); }
            100% { border-color: #27272a; box-shadow: none; }
        }
        @keyframes beatFlash {
            0% { border-color: var(--p-purple); }
            100% { border-color: #27272a; }
        }
        
        .world-container {
            position: absolute; width: 300%; height: 100%; left: -100%; top: 0;
            transform-style: preserve-3d;
        }
        .hallway { position: absolute; width: 33.33%; height: 100%; left: 33.33%; transform-style: preserve-3d; }
        .floor {
            position: absolute; width: 800px; height: 600px; left: 50%; bottom: -200px; margin-left: -400px;
            background: repeating-linear-gradient(90deg, var(--floor) 0px, var(--floor) 48px, #222228 48px, #222228 50px),
                        repeating-linear-gradient(0deg, var(--floor) 0px, var(--floor) 48px, #222228 48px, #222228 50px);
            transform: rotateX(75deg); transform-origin: center top;
        }
        .ceiling {
            position: absolute; width: 800px; height: 400px; left: 50%; top: -280px; margin-left: -400px;
            background: linear-gradient(180deg, #0a0a0f 0%, #15151a 100%);
            transform: rotateX(-75deg); transform-origin: center bottom;
        }
        .wall-left {
            position: absolute; width: 500px; height: 100%; left: -180px;
            background: linear-gradient(90deg, #0a0a0f 0%, var(--wall) 100%);
            transform: rotateY(70deg); transform-origin: right center; border-right: 2px solid #333;
        }
        .wall-right {
            position: absolute; width: 500px; height: 100%; right: -180px;
            background: linear-gradient(-90deg, #0a0a0f 0%, var(--wall) 100%);
            transform: rotateY(-70deg); transform-origin: left center; border-left: 2px solid #333;
        }
        
        /* DOORFRAME */
        .doorframe { position: absolute; width: 120px; height: 200px; left: 50%; bottom: 40px; margin-left: -60px; z-index: 10; }
        .doorframe-left, .doorframe-right {
            position: absolute; width: 25px; height: 100%;
            background: linear-gradient(90deg, #1f1f25 0%, var(--cover) 100%);
            border: 1px solid #3a3a42;
        }
        .doorframe-left { left: 0; box-shadow: inset -5px 0 15px rgba(0,0,0,0.5); }
        .doorframe-right { right: 0; background: linear-gradient(-90deg, #1f1f25 0%, var(--cover) 100%); box-shadow: inset 5px 0 15px rgba(0,0,0,0.5); }
        .doorframe-top { position: absolute; top: 0; left: 0; width: 100%; height: 20px; background: var(--cover); border: 1px solid #3a3a42; }

        /* ENEMY */
        .enemy-target { position: absolute; bottom: 90px; z-index: 8; transition: left 0.3s ease-out, opacity 0.2s; }
        .enemy-target.hidden { opacity: 0; pointer-events: none; }
        .enemy-target.dead { opacity: 0.3; filter: grayscale(1); }
        .enemy-body { width: 28px; height: 48px; background: linear-gradient(180deg, #cc3030 0%, #991f1f 100%); border-radius: 4px; position: relative; box-shadow: 0 0 15px rgba(255,75,75,0.4); }
        .enemy-head { position: absolute; top: -14px; left: 50%; margin-left: -9px; width: 18px; height: 18px; background: radial-gradient(circle at 30% 30%, #ff6b6b, #cc3030); border-radius: 50%; border: 2px solid #ff8888; }
        .enemy-spotted-indicator { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: var(--p-gold); font-weight: bold; opacity: 0; transition: opacity 0.2s; }
        .enemy-target.spotted .enemy-spotted-indicator { opacity: 1; }
        
        .bullet-impact { position: absolute; width: 8px; height: 8px; background: var(--p-gold); border-radius: 50%; transform: translate(-50%, -50%); z-index: 100; opacity: 0; pointer-events: none; box-shadow: 0 0 10px var(--p-gold); }
        .bullet-impact.visible { opacity: 1; animation: impactPulse 0.5s ease-out; }
        @keyframes impactPulse { 0% { transform: translate(-50%, -50%) scale(2); } 100% { transform: translate(-50%, -50%) scale(1); } }

        /* WEAPON */
        .weapon-container { position: absolute; bottom: 0; left: 50%; width: 200px; height: 160px; margin-left: -100px; z-index: 50; pointer-events: none; }
        .weapon-model { position: absolute; bottom: -20px; left: 50%; margin-left: -40px; transition: transform 0.08s ease-out; }
        .gun-body { position: relative; width: 80px; height: 45px; background: linear-gradient(180deg, #2a2a32 0%, #1a1a1f 100%); border-radius: 4px 8px 4px 4px; border: 1px solid #3a3a42; }
        .gun-barrel { position: absolute; top: 8px; right: -35px; width: 40px; height: 12px; background: linear-gradient(180deg, #3a3a42 0%, #1a1a1f 100%); border-radius: 2px 6px 6px 2px; border: 1px solid #4a4a52; }
        .gun-barrel::after { content: ''; position: absolute; right: -8px; top: 2px; width: 10px; height: 8px; background: #0a0a0f; border-radius: 1px 4px 4px 1px; }
        .muzzle-flash { position: absolute; top: -15px; right: -60px; width: 50px; height: 40px; background: radial-gradient(ellipse at center, rgba(255,200,50,0.9) 0%, rgba(255,150,0,0.6) 30%, transparent 100%); border-radius: 50%; opacity: 0; transform: scale(0.5); transition: opacity 0.05s, transform 0.05s; }
        .muzzle-flash.active { opacity: 1; transform: scale(1.2); }
        .gun-optic { position: absolute; top: -18px; left: 20px; width: 30px; height: 20px; background: linear-gradient(180deg, #222228 0%, #0f0f12 100%); border-radius: 3px; border: 1px solid #3a3a42; }
        .gun-optic::before { content: ''; position: absolute; top: 5px; left: 5px; width: 20px; height: 10px; background: linear-gradient(180deg, #001520 0%, #002535 100%); border-radius: 2px; border: 1px solid var(--p-blue); box-shadow: 0 0 8px rgba(0,212,255,0.3); }
        .gun-grip { position: absolute; bottom: -25px; left: 15px; width: 20px; height: 30px; background: linear-gradient(90deg, #1f1f25 0%, #2a2a32 50%, #1f1f25 100%); border-radius: 2px 2px 4px 4px; transform: skewX(-8deg); }
        .gun-mag { position: absolute; bottom: -20px; left: 40px; width: 12px; height: 25px; background: linear-gradient(90deg, #1a1a1f 0%, #2a2a32 100%); border-radius: 1px 1px 2px 2px; transform: skewX(-3deg); }
        
        /* CROSSHAIR */
        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 60; pointer-events: none; }
        .crosshair-dot { width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 4px rgba(255,255,255,0.8); }
        .crosshair-line { position: absolute; background: rgba(255,255,255,0.6); }
        .crosshair-line.h { width: 20px; height: 1px; top: 50%; margin-top: -0.5px; }
        .crosshair-line.h.left { right: 12px; }
        .crosshair-line.h.right { left: 12px; }
        .crosshair-line.v { width: 1px; height: 20px; left: 50%; margin-left: -0.5px; }
        .crosshair-line.v.top { bottom: 12px; }
        .crosshair-line.v.bottom { top: 12px; }
        
        .flash-overlay { position: absolute; inset: 0; opacity: 0; transition: opacity 0.1s; pointer-events: none; z-index: 40; }

        /* STATUS INDICATORS */
        .mode-indicator { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 0.65rem; color: var(--p-blue); text-transform: uppercase; letter-spacing: 2px; z-index: 70; background: rgba(0,0,0,0.7); padding: 4px 12px; border-radius: 4px; }
        .phase-indicator { position: absolute; top: 38px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; z-index: 70; background: rgba(0,0,0,0.7); padding: 3px 10px; border-radius: 4px; }
        .phase-indicator.intel { color: var(--p-gold); }
        .phase-indicator.kill { color: var(--p-red); }
        
        .exposure-bar-container { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); width: 200px; height: 6px; background: #222; border-radius: 3px; z-index: 70; overflow: hidden; opacity: 0; transition: opacity 0.2s; }
        .exposure-bar-container.active { opacity: 1; }
        .exposure-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--p-green) 0%, var(--p-gold) 50%, var(--p-red) 100%); transition: width 0.05s linear; }
        
        .death-overlay { position: absolute; inset: 0; background: rgba(255,0,0,0.4); z-index: 80; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
        .death-overlay.active { opacity: 1; }
        .death-text { font-size: 3rem; font-weight: 900; color: #fff; text-shadow: 0 0 30px #ff0000; animation: deathPulse 0.3s ease-out; }
        @keyframes deathPulse { 0% { transform: scale(0.5); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* BPM / RHYTHM SECTION */
        .rhythm-section {
            background: #000;
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .bpm-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .bpm-label {
            font-size: 0.7rem;
            color: #71717a;
            text-transform: uppercase;
        }
        
        .bpm-value {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--p-purple);
            min-width: 60px;
            text-align: center;
        }
        
        .bpm-slider {
            width: 120px;
            height: 6px;
            -webkit-appearance: none;
            background: #27272a;
            border-radius: 3px;
            outline: none;
        }
        
        .bpm-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--p-purple);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .metronome-toggle {
            padding: 8px 16px;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #71717a;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .metronome-toggle.active {
            background: var(--p-purple);
            border-color: var(--p-purple);
            color: #000;
        }
        
        /* BEAT INDICATORS */
        .beat-track {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .beat-dot {
            width: 12px;
            height: 12px;
            background: #27272a;
            border-radius: 50%;
            transition: 0.1s;
        }
        
        .beat-dot.pulse {
            background: var(--p-purple);
            box-shadow: 0 0 10px var(--p-purple);
            transform: scale(1.3);
        }
        
        .target-time {
            font-size: 0.8rem;
            color: #52525b;
        }
        
        .target-time span {
            color: var(--p-green);
            font-weight: bold;
        }

        /* COMBO TRACK */
        .combo-track { display: flex; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .key-node { 
            width: 65px; height: 65px; background: #27272a; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.8rem; font-weight: 800; color: #52525b; 
            border: 2px solid transparent; transition: 0.1s; position: relative; 
        }
        .key-node.active { border-color: var(--p-blue); color: #fff; box-shadow: 0 0 15px rgba(0,212,255,0.3); transform: scale(1.1); }
        .key-node.hit { background: var(--p-blue); color: #000; }
        .key-node.fire { background: var(--p-red); color: #fff; border-color: var(--p-red); }
        .key-node.on-beat { box-shadow: 0 0 20px var(--p-purple), 0 0 40px var(--p-purple); }
        .label { position: absolute; top: -16px; font-size: 0.65rem; color: #71717a; text-transform: uppercase; font-weight: bold; }
        
        /* Beat timing indicator under each key */
        .beat-timing {
            position: absolute;
            bottom: -18px;
            font-size: 0.55rem;
            color: var(--p-purple);
            font-weight: bold;
        }

        /* STATS */
        .stats-bar { 
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            background: #000; 
            padding: 12px 20px; 
            border-radius: 12px; 
        }
        .stat-group { text-align: center; }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.65rem; color: #71717a; }
        .stat-val.best { color: var(--p-gold); }
        .stat-val.avg { color: var(--p-green); }

        .swap-btn { 
            width: 100%; margin-top: 12px; padding: 10px; 
            background: transparent; border: 1px dashed #3f3f46; 
            color: #71717a; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .swap-btn:hover { border-color: var(--p-blue); color: var(--p-blue); }
        
        .instructions { margin-top: 8px; font-size: 0.65rem; color: #52525b; text-align: center; line-height: 1.5; }
        
        /* Hotkey hints */
        .hotkeys {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.6rem;
            color: #3f3f46;
        }
        .hotkeys kbd {
            background: #27272a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #71717a;
        }
    </style>
</head>
<body>

    <a href="index.html" class="back-link">← BACK TO DASHBOARD</a>

    <div class="lab-card">
        <div id="rank-display" class="rank-badge">D</div>
        <h1 style="margin:0; font-size: 1.6rem;">SHAIIKO PEEK TRAINER <span style="color:var(--p-purple)">PRO</span></h1>
        <p style="color:#71717a; margin-top:5px; font-size: 0.8rem;">RHYTHM TRAINING • INTEL/KILL SYSTEM • TIMING ANALYSIS</p>

        <!-- BPM / RHYTHM CONTROLS -->
        <div class="rhythm-section">
            <div class="bpm-control">
                <span class="bpm-label">BPM</span>
                <input type="range" class="bpm-slider" id="bpm-slider" min="60" max="200" value="120">
                <span class="bpm-value" id="bpm-value">120</span>
                <button class="metronome-toggle" id="metronome-toggle" onclick="toggleMetronome()">♪ METRONOME</button>
            </div>
            <div class="beat-track">
                <div class="beat-dot" id="beat-1"></div>
                <div class="beat-dot" id="beat-2"></div>
                <div class="beat-dot" id="beat-3"></div>
                <div class="beat-dot" id="beat-4"></div>
            </div>
            <div class="target-time">
                Target: <span id="target-time">500ms</span>
            </div>
        </div>

        <div id="viewport" class="viewport">
            <div id="flash" class="flash-overlay"></div>
            <div class="mode-indicator" id="mode-indicator">RIGHT PEEK</div>
            <div class="phase-indicator intel" id="phase-indicator">PHASE 1: INTEL</div>
            
            <div class="exposure-bar-container" id="exposure-container">
                <div class="exposure-bar" id="exposure-bar"></div>
            </div>
            
            <div class="death-overlay" id="death-overlay">
                <div class="death-text" id="death-text">TRADED</div>
            </div>
            
            <div id="world" class="world-container">
                <div class="hallway">
                    <div class="floor"></div>
                    <div class="ceiling"></div>
                    <div class="wall-left"></div>
                    <div class="wall-right"></div>
                    <div class="doorframe" id="doorframe">
                        <div class="doorframe-left"></div>
                        <div class="doorframe-right"></div>
                        <div class="doorframe-top"></div>
                    </div>
                    <div class="enemy-target" id="enemy">
                        <div class="enemy-spotted-indicator">⚠ SPOTTED</div>
                        <div class="enemy-head" id="enemy-head"></div>
                        <div class="enemy-body" id="enemy-body"></div>
                    </div>
                </div>
            </div>
            
            <div class="bullet-impact" id="bullet-impact"></div>
            
            <div class="crosshair">
                <div class="crosshair-dot"></div>
                <div class="crosshair-line h left"></div>
                <div class="crosshair-line h right"></div>
                <div class="crosshair-line v top"></div>
                <div class="crosshair-line v bottom"></div>
            </div>
            
            <div class="weapon-container">
                <div id="weapon" class="weapon-model">
                    <div class="gun-body">
                        <div class="gun-barrel">
                            <div id="muzzle-flash" class="muzzle-flash"></div>
                        </div>
                        <div class="gun-optic"></div>
                        <div class="gun-grip"></div>
                        <div class="gun-mag"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="combo-track">
            <div id="k0" class="key-node"><span class="label">STEP 1</span>-<span class="beat-timing">Beat 1</span></div>
            <div id="k1" class="key-node"><span class="label">STEP 2</span>-<span class="beat-timing">Beat 2</span></div>
            <div id="k2" class="key-node"><span class="label">STEP 3</span>-<span class="beat-timing">Beat 3</span></div>
            <div id="k3" class="key-node"><span class="label">STEP 4</span>-<span class="beat-timing">Beat 4</span></div>
        </div>

        <div class="stats-bar">
            <div class="stat-group">
                <div class="stat-label">LAST TIME</div>
                <div id="time" class="stat-val">0ms</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">BEST TIME</div>
                <div id="best-time" class="stat-val best">-</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">AVG TIME</div>
                <div id="avg-time" class="stat-val avg">-</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">ACCURACY</div>
                <div id="accuracy" class="stat-val">0%</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">FEEDBACK</div>
                <div id="msg" class="stat-val" style="color:var(--p-gold)">READY</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">STREAK</div>
                <div id="streak" class="stat-val">0</div>
            </div>
        </div>

        <button class="swap-btn" onclick="toggleMode()">[SPACE] SWAP LEFT/RIGHT PEEK</button>
        
        <div class="hotkeys">
            <span><kbd>M</kbd> Toggle Metronome</span>
            <span><kbd>↑/↓</kbd> Adjust BPM</span>
            <span><kbd>R</kbd> Reset Stats</span>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SEQS = {
            'ADEQ': ['a', 'd', 'e', 'q'],
            'DAQE': ['d', 'a', 'q', 'e']
        };
        
        const TARGET_POS = {
            left: 'calc(50% - 80px)',
            right: 'calc(50% + 80px)'
        };
        
        let mode = 'ADEQ';
        let idx = 0;
        let startTime = 0;
        let streak = 0;
        
        // Two-Peek System
        let gamePhase = 'intel';
        let targetSpotted = false;
        let firedThisPeek = false;
        
        // Exposure Timer
        let exposureStart = 0;
        let exposureTimer = null;
        const MAX_EXPOSURE = 250;
        
        // Stats Tracking
        let allTimes = [];
        let successfulKills = 0;
        let totalAttempts = 0;
        let bestTime = Infinity;
        
        // BPM / Metronome
        let bpm = 120;
        let metronomeActive = false;
        let metronomeInterval = null;
        let currentBeat = 0;
        
        // ============================================
        // LERP MOVEMENT ENGINE
        // ============================================
        const movement = { currentX: 0, targetX: 0, currentLean: 0, targetLean: 0 };
        const LERP_FACTOR = 0.15;
        
        function lerp(a, b, t) { return a + (b - a) * t; }
        
        function gameLoop() {
            movement.currentX = lerp(movement.currentX, movement.targetX, LERP_FACTOR);
            movement.currentLean = lerp(movement.currentLean, movement.targetLean, LERP_FACTOR);
            
            document.getElementById('world').style.transform = `translateX(${movement.currentX}px)`;
            
            const weapon = document.getElementById('weapon');
            const rot = lerp(parseFloat(weapon.dataset.rotate || 0), movement.targetLean * 12, LERP_FACTOR);
            const shift = lerp(parseFloat(weapon.dataset.shift || 0), movement.targetLean * 20, LERP_FACTOR);
            weapon.dataset.rotate = rot;
            weapon.dataset.shift = shift;
            weapon.style.transform = `translateX(${shift}px) rotateZ(${rot}deg)`;
            
            requestAnimationFrame(gameLoop);
        }
        requestAnimationFrame(gameLoop);

        // ============================================
        // BPM / METRONOME SYSTEM
        // ============================================
        function updateBPM(newBpm) {
            bpm = newBpm;
            document.getElementById('bpm-value').innerText = bpm;
            
            // Calculate target time (4 beats = full sequence)
            const beatMs = 60000 / bpm;
            const targetMs = Math.round(beatMs * 3); // 3 intervals for 4 beats
            document.getElementById('target-time').innerText = targetMs + 'ms';
            
            // Restart metronome if active
            if (metronomeActive) {
                stopMetronome();
                startMetronome();
            }
        }
        
        function toggleMetronome() {
            metronomeActive = !metronomeActive;
            const btn = document.getElementById('metronome-toggle');
            
            if (metronomeActive) {
                btn.classList.add('active');
                startMetronome();
            } else {
                btn.classList.remove('active');
                stopMetronome();
            }
        }
        
        function startMetronome() {
            const beatMs = 60000 / bpm;
            currentBeat = 0;
            
            metronomeInterval = setInterval(() => {
                // Visual beat
                for (let i = 1; i <= 4; i++) {
                    document.getElementById('beat-' + i).classList.remove('pulse');
                }
                currentBeat = (currentBeat % 4) + 1;
                document.getElementById('beat-' + currentBeat).classList.add('pulse');
                
                // Highlight corresponding key
                if (currentBeat <= 4) {
                    for (let i = 0; i < 4; i++) {
                        document.getElementById('k' + i).classList.remove('on-beat');
                    }
                    document.getElementById('k' + (currentBeat - 1)).classList.add('on-beat');
                }
                
                // Audio click
                playMetronomeClick(currentBeat === 1);
                
                // Visual flash on viewport
                document.getElementById('viewport').classList.add('beat-flash');
                setTimeout(() => document.getElementById('viewport').classList.remove('beat-flash'), 50);
                
            }, beatMs);
        }
        
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            for (let i = 1; i <= 4; i++) {
                document.getElementById('beat-' + i).classList.remove('pulse');
            }
            for (let i = 0; i < 4; i++) {
                document.getElementById('k' + i).classList.remove('on-beat');
            }
        }
        
        function playMetronomeClick(accent) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(accent ? 1000 : 800, audioCtx.currentTime);
            gain.gain.setValueAtTime(accent ? 0.15 : 0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }
        
        // BPM Slider
        document.getElementById('bpm-slider').addEventListener('input', (e) => {
            updateBPM(parseInt(e.target.value));
        });

        // ============================================
        // STATS TRACKING
        // ============================================
        function updateStats(time, success) {
            totalAttempts++;
            if (success) {
                successfulKills++;
                allTimes.push(time);
                
                if (time < bestTime) {
                    bestTime = time;
                    document.getElementById('best-time').innerText = bestTime + 'ms';
                }
                
                const avg = Math.round(allTimes.reduce((a, b) => a + b, 0) / allTimes.length);
                document.getElementById('avg-time').innerText = avg + 'ms';
            }
            
            const accuracy = Math.round((successfulKills / totalAttempts) * 100);
            document.getElementById('accuracy').innerText = accuracy + '%';
        }
        
        function resetStats() {
            allTimes = [];
            successfulKills = 0;
            totalAttempts = 0;
            bestTime = Infinity;
            streak = 0;
            
            document.getElementById('best-time').innerText = '-';
            document.getElementById('avg-time').innerText = '-';
            document.getElementById('accuracy').innerText = '0%';
            document.getElementById('streak').innerText = '0';
            document.getElementById('msg').innerText = 'STATS RESET';
        }

        // ============================================
        // TARGET POSITIONING
        // ============================================
        function positionTarget() {
            const enemy = document.getElementById('enemy');
            if (mode === 'ADEQ') {
                enemy.style.left = TARGET_POS.right;
                enemy.style.marginLeft = '-14px';
            } else {
                enemy.style.left = TARGET_POS.left;
                enemy.style.marginLeft = '-14px';
            }
        }

        // ============================================
        // AUDIO ENGINE
        // ============================================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const sounds = {
                success: { type: 'sine', freq: [800, 1200], gain: 0.3, dur: 0.3 },
                click: { type: 'triangle', freq: [300], gain: 0.1, dur: 0.05 },
                fail: { type: 'square', freq: [150], gain: 0.2, dur: 0.2 },
                shot: { type: 'sawtooth', freq: [150, 50], gain: 0.4, dur: 0.15 },
                headshot: { type: 'sine', freq: [1000, 1500], gain: 0.4, dur: 0.2 },
                death: { type: 'sawtooth', freq: [100, 40], gain: 0.5, dur: 0.4 }
            };
            
            const s = sounds[type];
            osc.type = s.type;
            osc.frequency.setValueAtTime(s.freq[0], audioCtx.currentTime);
            if (s.freq[1]) osc.frequency.exponentialRampToValueAtTime(s.freq[1], audioCtx.currentTime + s.dur * 0.5);
            gain.gain.setValueAtTime(s.gain, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + s.dur);
            osc.start();
            osc.stop(audioCtx.currentTime + s.dur);
        }

        // ============================================
        // EXPOSURE TIMER
        // ============================================
        function startExposureTimer() {
            exposureStart = performance.now();
            const container = document.getElementById('exposure-container');
            const bar = document.getElementById('exposure-bar');
            container.classList.add('active');
            
            exposureTimer = setInterval(() => {
                const elapsed = performance.now() - exposureStart;
                const percent = Math.min((elapsed / MAX_EXPOSURE) * 100, 100);
                bar.style.width = percent + '%';
                
                if (elapsed >= MAX_EXPOSURE) {
                    triggerDeath('TRADED');
                }
            }, 16);
        }
        
        function stopExposureTimer() {
            if (exposureTimer) {
                clearInterval(exposureTimer);
                exposureTimer = null;
            }
            document.getElementById('exposure-container').classList.remove('active');
            document.getElementById('exposure-bar').style.width = '0%';
        }
        
        function triggerDeath(reason) {
            stopExposureTimer();
            playSound('death');
            
            const overlay = document.getElementById('death-overlay');
            const text = document.getElementById('death-text');
            text.innerText = reason;
            overlay.classList.add('active');
            
            document.getElementById('viewport').classList.add('death-flash');
            
            updateStats(0, false);
            streak = 0;
            document.getElementById('streak').innerText = 0;
            document.getElementById('msg').innerText = reason;
            
            setTimeout(() => {
                overlay.classList.remove('active');
                document.getElementById('viewport').classList.remove('death-flash');
                fullReset();
            }, 800);
        }

        // ============================================
        // SHOT REGISTRATION
        // ============================================
        function checkHit() {
            const head = document.getElementById('enemy-head');
            const impact = document.getElementById('bullet-impact');
            const viewport = document.getElementById('viewport');
            const vRect = viewport.getBoundingClientRect();
            const headRect = head.getBoundingClientRect();
            
            const hitZone = 'KILL';
            const score = 100;
            
            const impactX = headRect.left - vRect.left + headRect.width / 2;
            const impactY = headRect.top - vRect.top + headRect.height / 2;
            
            playSound('headshot');
            
            impact.style.left = impactX + 'px';
            impact.style.top = impactY + 'px';
            impact.classList.add('visible');
            setTimeout(() => impact.classList.remove('visible'), 500);
            
            return { hitZone, score };
        }

        // ============================================
        // VISUAL FEEDBACK
        // ============================================
        function triggerMuzzleFlash() {
            const flash = document.getElementById('muzzle-flash');
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 80);
        }
        
        function triggerScreenShake() {
            document.getElementById('viewport').classList.add('shake');
            setTimeout(() => document.getElementById('viewport').classList.remove('shake'), 150);
        }
        
        function updateMovement() {
            const patterns = {
                'ADEQ': [{ x: 80, lean: 0 }, { x: -60, lean: 0 }, { x: -80, lean: 1 }, { x: -40, lean: -0.3 }],
                'DAQE': [{ x: -80, lean: 0 }, { x: 60, lean: 0 }, { x: 80, lean: -1 }, { x: 40, lean: 0.3 }]
            };
            if (idx <= 3) {
                const p = patterns[mode][idx];
                movement.targetX = p.x;
                movement.targetLean = p.lean;
            }
        }
        
        function updatePhaseUI() {
            const phaseEl = document.getElementById('phase-indicator');
            if (gamePhase === 'intel') {
                phaseEl.innerText = 'PHASE 1: INTEL';
                phaseEl.className = 'phase-indicator intel';
            } else {
                phaseEl.innerText = 'PHASE 2: KILL';
                phaseEl.className = 'phase-indicator kill';
            }
        }

        // ============================================
        // CORE GAME LOGIC
        // ============================================
        function init() {
            const keys = SEQS[mode];
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('k'+i);
                el.childNodes[1].nodeValue = keys[i].toUpperCase();
                el.className = 'key-node';
            }
            document.getElementById('k0').classList.add('active');
            document.getElementById('msg').innerText = gamePhase === 'intel' ? 'GATHER INTEL' : 'EXECUTE';
            document.getElementById('mode-indicator').innerText = mode === 'ADEQ' ? 'RIGHT PEEK' : 'LEFT PEEK';
            
            positionTarget();
            
            const enemy = document.getElementById('enemy');
            enemy.classList.remove('hidden', 'dead');
            if (targetSpotted) enemy.classList.add('spotted');
            
            movement.targetX = 0;
            movement.targetLean = 0;
            firedThisPeek = false;
            
            updatePhaseUI();
        }

        document.getElementById('viewport').addEventListener('contextmenu', (e) => e.preventDefault());
        
        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            
            if (k === ' ') { e.preventDefault(); toggleMode(); return; }
            if (k === 'm') { toggleMetronome(); return; }
            if (k === 'r') { resetStats(); return; }
            if (k === 'arrowup') { updateBPM(Math.min(200, bpm + 5)); document.getElementById('bpm-slider').value = bpm; return; }
            if (k === 'arrowdown') { updateBPM(Math.max(60, bpm - 5)); document.getElementById('bpm-slider').value = bpm; return; }

            const targetKey = SEQS[mode][idx];
            
            if (k === targetKey) {
                if (idx === 0) startTime = performance.now();
                playSound('click');
                
                document.getElementById('k'+idx).classList.remove('active');
                document.getElementById('k'+idx).classList.add('hit');

                idx++;
                updateMovement();
                

                
                if (idx < 4) {
                    document.getElementById('k'+idx).classList.add('active');
                } else {
                    const totalTime = (performance.now() - startTime).toFixed(0);
                    finishSequence(totalTime, false);
                }

            } else if (['a','d','e','q'].includes(k)) {
                fail();
            }
        });
        
        
        function finishSequence(ms) {
            stopExposureTimer();
            document.getElementById('time').innerText = ms + 'ms';
            
            if (gamePhase === 'intel') {
                // Intel phase complete - spot target
                targetSpotted = true;
                document.getElementById('enemy').classList.add('spotted');
                document.getElementById('msg').innerText = 'TARGET SPOTTED';
                playSound('success');
                
                // Instant transition to kill phase
                gamePhase = 'kill';
                reset();
                
            } else if (gamePhase === 'kill') {
                // Kill phase - AUTO FIRE on sequence complete
                triggerMuzzleFlash();
                triggerScreenShake();
                document.getElementById('k3').classList.add('fire');
                
                const { hitZone, score } = checkHit();
                finishKill(parseInt(ms), hitZone, score);
            }
        }
        
        function finishKill(ms, hitZone, score) {
            document.getElementById('time').innerText = ms + 'ms';
            
            const rankEl = document.getElementById('rank-display');
            const flash = document.getElementById('flash');
            const targetMs = Math.round((60000 / bpm) * 3);
            
            let rank = 'D';
            
            // Compare against BPM target time
            if (ms <= targetMs * 0.8) {
                rank = 'S';
                streak++;
                flash.style.background = '#ffcc00';
                document.getElementById('msg').innerText = 'GODLIKE';
                document.getElementById('enemy').classList.add('dead');
                updateStats(ms, true);
            } else if (ms <= targetMs) {
                rank = 'A';
                streak++;
                flash.style.background = '#00d4ff';
                document.getElementById('msg').innerText = 'ON BEAT';
                document.getElementById('enemy').classList.add('dead');
                updateStats(ms, true);
            } else {
                rank = 'F';
                streak = 0;
                flash.style.background = '#ff4b4b';
                document.getElementById('msg').innerText = 'OFF BEAT';
                document.getElementById('enemy').classList.add('dead');
                updateStats(ms, false);
            }

            rankEl.innerText = rank;
            rankEl.className = 'rank-badge rank-' + rank;
            document.getElementById('streak').innerText = streak;
            
            flash.style.opacity = '0.3';
            setTimeout(() => document.getElementById('flash').style.opacity = '0', 100);
            
            // Instant reset to next round
            fullReset();
        }

        function fail() {
            stopExposureTimer();
            playSound('fail');
            updateStats(0, false);
            streak = 0;
            document.getElementById('streak').innerText = 0;
            document.getElementById('msg').innerText = 'MISCLICK';
            document.getElementById('flash').style.background = '#ff4b4b';
            document.getElementById('flash').style.opacity = '0.3';
            setTimeout(() => document.getElementById('flash').style.opacity = '0', 100);
            
            // Instant reset
            reset();
        }

        function reset() {
            idx = 0;
            init();
            document.getElementById('flash').style.opacity = '0';
        }
        
        function fullReset() {
            gamePhase = 'intel';
            targetSpotted = false;
            firedThisPeek = false;
            reset();
        }

        function toggleMode() {
            mode = mode === 'ADEQ' ? 'DAQE' : 'ADEQ';
            streak = 0;
            document.getElementById('streak').innerText = 0;
            fullReset();
        }

        // Initialize
        updateBPM(120);
        init();
    </script>
</body>
</html>
