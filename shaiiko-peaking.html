<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>R6 Coach Pro: Tactical Simulator</title>
    <style>
        :root { 
            --p-blue: #3b82f6; 
            --p-gold: #f59e0b; 
            --p-red: #ef4444; 
            --p-green: #10b981;
            --p-purple: #8b5cf6;
            --p-accent: #6366f1;
            --bg: #09090b; 
            --card: #18181b;
            --floor: #1a1a1f;
            --wall: #0f0f12;
            --cover: #2a2a32;
        }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); 
            color: #fff; 
            font-family: 'Inter', -apple-system, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            margin: 0;
            min-height: 100vh;
        }
        
        .lab-card { 
            background: var(--card); 
            padding: 24px 28px; 
            border-radius: 12px; 
            border: 1px solid #27272a; 
            width: 100%;
            max-width: 1400px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.5); 
            position: relative; 
            margin-top: 30px; 
        }
        
        

        /* Rank display removed - shown in stats bar instead */

        /* 3D VIEWPORT */
        .viewport { 
            height: 500px; 
            background: linear-gradient(180deg, #050508 0%, #0a0a0f 100%);
            border-radius: 8px; margin: 12px 0; position: relative; 
            overflow: hidden; border: 2px solid #27272a;
            perspective: 1200px; perspective-origin: 50% 60%;
        }
        .viewport.shake { animation: screenShake 0.05s ease-out; }
        .viewport.death-flash { animation: deathFlash 0.5s ease-out; }
        .viewport.beat-flash { animation: beatFlash 0.1s ease-out; }
        
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-3px); }
        }
        @keyframes deathFlash {
            0% { border-color: #ff0000; box-shadow: inset 0 0 100px rgba(255,0,0,0.8); }
            100% { border-color: #27272a; box-shadow: none; }
        }
        @keyframes beatFlash {
            0% { border-color: var(--p-purple); }
            100% { border-color: #27272a; }
        }
        
        /* GAME JUICE ANIMATIONS */
        .viewport.juice-shake { 
            animation: juiceShake 0.15s ease-out; 
        }
        @keyframes juiceShake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-6px) rotate(-1deg); } 
            75% { transform: translateX(4px); } 
        }
        
        .viewport.chromatic { 
            animation: chromaticPulse 0.3s ease-out; 
        }
        @keyframes chromaticPulse { 
            0% { filter: drop-shadow(4px 0 0 rgba(255,0,0,0.6)) drop-shadow(-4px 0 0 rgba(0,255,255,0.6)); } 
            100% { filter: none; } 
        }
        
        .world-container {
            position: absolute; width: 300%; height: 100%; left: -100%; top: 0;
            transform-style: preserve-3d;
        }
        .hallway { position: absolute; width: 33.33%; height: 100%; left: 33.33%; transform-style: preserve-3d; }
        .floor {
            position: absolute; width: 800px; height: 600px; left: 50%; bottom: -200px; margin-left: -400px;
            background: repeating-linear-gradient(90deg, var(--floor) 0px, var(--floor) 48px, #222228 48px, #222228 50px),
                        repeating-linear-gradient(0deg, var(--floor) 0px, var(--floor) 48px, #222228 48px, #222228 50px);
            transform: rotateX(75deg); transform-origin: center top;
        }
        .ceiling {
            position: absolute; width: 800px; height: 400px; left: 50%; top: -280px; margin-left: -400px;
            background: linear-gradient(180deg, #0a0a0f 0%, #15151a 100%);
            transform: rotateX(-75deg); transform-origin: center bottom;
        }
        .wall-left {
            position: absolute; width: 500px; height: 100%; left: -180px;
            background: linear-gradient(90deg, #0a0a0f 0%, var(--wall) 100%);
            transform: rotateY(70deg); transform-origin: right center; border-right: 2px solid #333;
        }
        .wall-right {
            position: absolute; width: 500px; height: 100%; right: -180px;
            background: linear-gradient(-90deg, #0a0a0f 0%, var(--wall) 100%);
            transform: rotateY(-70deg); transform-origin: left center; border-left: 2px solid #333;
        }
        
        /* DOORFRAME */
        .doorframe { position: absolute; width: 120px; height: 200px; left: 50%; bottom: 40px; margin-left: -60px; z-index: 10; }
        .doorframe-left, .doorframe-right {
            position: absolute; width: 25px; height: 100%;
            background: linear-gradient(90deg, #1f1f25 0%, var(--cover) 100%);
            border: 1px solid #3a3a42;
        }
        .doorframe-left { left: 0; box-shadow: inset -5px 0 15px rgba(0,0,0,0.5); }
        .doorframe-right { right: 0; background: linear-gradient(-90deg, #1f1f25 0%, var(--cover) 100%); box-shadow: inset 5px 0 15px rgba(0,0,0,0.5); }
        .doorframe-top { position: absolute; top: 0; left: 0; width: 100%; height: 20px; background: var(--cover); border: 1px solid #3a3a42; }

        /* ENEMY */
        .enemy-target { position: absolute; bottom: 90px; z-index: 8; transition: left 0.3s ease-out, opacity 0.2s; }
        .enemy-target.hidden { opacity: 0; pointer-events: none; }
        .enemy-target.dead { opacity: 0.3; filter: grayscale(1); }
        .enemy-body { width: 28px; height: 48px; background: linear-gradient(180deg, #cc3030 0%, #991f1f 100%); border-radius: 4px; position: relative; box-shadow: 0 0 15px rgba(255,75,75,0.4); }
        .enemy-head { position: absolute; top: -14px; left: 50%; margin-left: -9px; width: 18px; height: 18px; background: radial-gradient(circle at 30% 30%, #ff6b6b, #cc3030); border-radius: 50%; border: 2px solid #ff8888; }
        .enemy-spotted-indicator { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: var(--p-gold); font-weight: bold; opacity: 0; transition: opacity 0.2s; }
        .enemy-target.spotted .enemy-spotted-indicator { opacity: 1; }
        
        .bullet-impact { position: absolute; width: 8px; height: 8px; background: var(--p-gold); border-radius: 50%; transform: translate(-50%, -50%); z-index: 100; opacity: 0; pointer-events: none; box-shadow: 0 0 10px var(--p-gold); }
        .bullet-impact.visible { opacity: 1; animation: impactPulse 0.5s ease-out; }
        @keyframes impactPulse { 0% { transform: translate(-50%, -50%) scale(2); } 100% { transform: translate(-50%, -50%) scale(1); } }

        /* WEAPON */
        .weapon-container { position: absolute; bottom: 0; left: 50%; width: 200px; height: 160px; margin-left: -100px; z-index: 50; pointer-events: none; }
        .weapon-model { position: absolute; bottom: -20px; left: 50%; margin-left: -40px; transition: transform 0.08s ease-out; }
        .gun-body { position: relative; width: 80px; height: 45px; background: linear-gradient(180deg, #2a2a32 0%, #1a1a1f 100%); border-radius: 4px 8px 4px 4px; border: 1px solid #3a3a42; }
        .gun-barrel { position: absolute; top: 8px; right: -35px; width: 40px; height: 12px; background: linear-gradient(180deg, #3a3a42 0%, #1a1a1f 100%); border-radius: 2px 6px 6px 2px; border: 1px solid #4a4a52; }
        .gun-barrel::after { content: ''; position: absolute; right: -8px; top: 2px; width: 10px; height: 8px; background: #0a0a0f; border-radius: 1px 4px 4px 1px; }
        .muzzle-flash { position: absolute; top: -15px; right: -60px; width: 50px; height: 40px; background: radial-gradient(ellipse at center, rgba(255,200,50,0.9) 0%, rgba(255,150,0,0.6) 30%, transparent 100%); border-radius: 50%; opacity: 0; transform: scale(0.5); transition: opacity 0.05s, transform 0.05s; }
        .muzzle-flash.active { opacity: 1; transform: scale(1.2); }
        .gun-optic { position: absolute; top: -18px; left: 20px; width: 30px; height: 20px; background: linear-gradient(180deg, #222228 0%, #0f0f12 100%); border-radius: 3px; border: 1px solid #3a3a42; }
        .gun-optic::before { content: ''; position: absolute; top: 5px; left: 5px; width: 20px; height: 10px; background: linear-gradient(180deg, #001520 0%, #002535 100%); border-radius: 2px; border: 1px solid var(--p-blue); box-shadow: 0 0 8px rgba(0,212,255,0.3); }
        .gun-grip { position: absolute; bottom: -25px; left: 15px; width: 20px; height: 30px; background: linear-gradient(90deg, #1f1f25 0%, #2a2a32 50%, #1f1f25 100%); border-radius: 2px 2px 4px 4px; transform: skewX(-8deg); }
        .gun-mag { position: absolute; bottom: -20px; left: 40px; width: 12px; height: 25px; background: linear-gradient(90deg, #1a1a1f 0%, #2a2a32 100%); border-radius: 1px 1px 2px 2px; transform: skewX(-3deg); }
        
        /* CROSSHAIR */
        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 60; pointer-events: none; }
        .crosshair-dot { width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 4px rgba(255,255,255,0.8); }
        .crosshair-line { position: absolute; background: rgba(255,255,255,0.6); }
        .crosshair-line.h { width: 20px; height: 1px; top: 50%; margin-top: -0.5px; }
        .crosshair-line.h.left { right: 12px; }
        .crosshair-line.h.right { left: 12px; }
        .crosshair-line.v { width: 1px; height: 20px; left: 50%; margin-left: -0.5px; }
        .crosshair-line.v.top { bottom: 12px; }
        .crosshair-line.v.bottom { top: 12px; }
        .crosshair.recoil { animation: recoilKick 0.04s ease-out; }
        @keyframes recoilKick { 0% { transform: translate(-50%, -50%) translateY(-3px); } 100% { transform: translate(-50%, -50%); } }
        
        .flash-overlay { position: absolute; inset: 0; opacity: 0; transition: opacity 0.1s; pointer-events: none; z-index: 40; }

        /* STATUS INDICATORS */
        .mode-indicator { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 0.65rem; color: var(--p-blue); text-transform: uppercase; letter-spacing: 2px; z-index: 70; background: rgba(0,0,0,0.7); padding: 4px 12px; border-radius: 4px; }
        .phase-indicator { position: absolute; top: 38px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; z-index: 70; background: rgba(0,0,0,0.7); padding: 3px 10px; border-radius: 4px; }
        .phase-indicator.intel { color: var(--p-gold); }
        .phase-indicator.kill { color: var(--p-red); }
        
        .exposure-bar-container { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); width: 200px; height: 6px; background: #222; border-radius: 3px; z-index: 70; overflow: hidden; opacity: 0; transition: opacity 0.2s; }
        .exposure-bar-container.active { opacity: 1; }
        .exposure-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--p-green) 0%, var(--p-gold) 50%, var(--p-red) 100%); transition: width 0.05s linear; }
        
        .death-overlay { position: absolute; inset: 0; background: rgba(255,0,0,0.4); z-index: 80; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
        .death-overlay.active { opacity: 1; }
        .death-text { font-size: 3rem; font-weight: 900; color: #fff; text-shadow: 0 0 30px #ff0000; animation: deathPulse 0.3s ease-out; }
        @keyframes deathPulse { 0% { transform: scale(0.5); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* BPM / RHYTHM SECTION */
        .rhythm-section {
            background: #0a0a0c;
            border-radius: 8px;
            padding: 10px 16px;
            margin-bottom: 12px;
            border: 1px solid #1f1f23;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .bpm-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .bpm-label {
            font-size: 0.7rem;
            color: #71717a;
            text-transform: uppercase;
        }
        
        .bpm-value {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--p-purple);
            min-width: 60px;
            text-align: center;
        }
        
        .bpm-slider {
            width: 120px;
            height: 6px;
            -webkit-appearance: none;
            background: #27272a;
            border-radius: 3px;
            outline: none;
        }
        
        .bpm-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--p-purple);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .metronome-toggle {
            padding: 8px 16px;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #71717a;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .metronome-toggle.active {
            background: #3f3f46;
            border-color: #52525b;
            color: #fff;
        }
        
        /* BEAT INDICATORS */
        .beat-track {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .beat-dot {
            width: 12px;
            height: 12px;
            background: #27272a;
            border-radius: 50%;
            transition: 0.1s;
        }
        
        .beat-dot.pulse {
            background: var(--p-purple);
            transform: scale(1.2);
        }
        
        .target-time {
            font-size: 0.8rem;
            color: #52525b;
        }
        
        .target-time span {
            color: var(--p-green);
            font-weight: bold;
        }

        /* FLOATING KEY INDICATORS (inside viewport) */
        .combo-track { 
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translateX(-50%);
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            z-index: 65;
            pointer-events: none;
        }
        .key-node { 
            width: 40px; height: 40px; 
            background: rgba(31, 31, 35, 0.6); 
            backdrop-filter: blur(4px);
            border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.1rem; font-weight: 700; 
            color: rgba(255,255,255,0.5); 
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            border: 1px solid rgba(63, 63, 70, 0.5); 
            transition: 0.1s; 
            position: relative;
            opacity: 0.7;
        }
        .key-node.active { 
            border-color: var(--p-blue); 
            color: #fff; 
            opacity: 1;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
        }
        .key-node.hit { 
            background: rgba(59, 130, 246, 0.8); 
            color: #fff; 
            opacity: 1;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
        }
        .key-node.fire { 
            background: rgba(239, 68, 68, 0.9); 
            color: #fff; 
            border-color: var(--p-red); 
            opacity: 1;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
        }
        .key-node.on-beat { 
            border-color: var(--p-purple); 
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        .key-node .label { display: none; }
        .key-node .beat-timing { display: none; }
        
        /* PHONK BEAT TOGGLE */
        .phonk-toggle {
            padding: 8px 14px;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #71717a;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .phonk-toggle.active {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            border-color: #a855f7;
            color: #fff;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
        }
        .phonk-toggle:hover { border-color: #52525b; }

        /* STATS - BENTO GRID with Glassmorphism */
        .stats-bar { 
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            padding: 12px 0; 
        }
        .stat-group { 
            text-align: center;
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(63, 63, 70, 0.5);
            border-radius: 10px;
            padding: 12px 8px;
        }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.65rem; color: #71717a; }
        .stat-val.best { color: var(--p-gold); }
        .stat-val.avg { color: var(--p-green); }

        .swap-btn { 
            width: 100%; margin-top: 10px; padding: 10px; 
            background: transparent; border: 1px solid #27272a; 
            color: #52525b; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.75rem; transition: 0.2s;
        }
        .swap-btn:hover { border-color: #3f3f46; color: #71717a; }
        
        .instructions { margin-top: 8px; font-size: 0.65rem; color: #52525b; text-align: center; line-height: 1.5; }
        
        /* Hotkey hints */
        .hotkeys {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.6rem;
            color: #3f3f46;
        }
        .hotkeys kbd {
            background: #27272a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #71717a;
        }
        
        /* DIFFICULTY PRESETS */
        .difficulty-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .diff-btn {
            flex: 1;
            padding: 8px 6px;
            background: #1f1f23;
            border: 1px solid #27272a;
            border-radius: 6px;
            color: #71717a;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
            letter-spacing: 0.3px;
        }
        .diff-btn:hover { border-color: #52525b; color: #a1a1aa; }
        .diff-btn.active { background: #3f3f46; border-color: #52525b; color: #fff; }
        .diff-btn .diff-bpm { font-size: 0.6rem; opacity: 0.7; display: block; margin-top: 2px; }
        
        /* TIMING BREAKDOWN */
        .timing-breakdown {
            background: #0a0a0c;
            border-radius: 8px;
            padding: 10px 16px;
            margin-top: 10px;
            border: 1px solid #1f1f23;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .split-time {
            text-align: center;
            padding: 8px;
            background: #18181b;
            border-radius: 8px;
        }
        .split-label { font-size: 0.6rem; color: #52525b; text-transform: uppercase; }
        .split-val { font-size: 1rem; font-weight: bold; color: #fff; margin-top: 2px; }
        .split-val.fast { color: var(--p-green); }
        .split-val.slow { color: var(--p-red); }
        .split-val.ok { color: var(--p-gold); }
        
        /* PERFORMANCE GRAPH */
        .perf-graph {
            background: #0a0a0c;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 10px;
            border: 1px solid #1f1f23;
        }
        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .graph-title { font-size: 0.7rem; color: #71717a; text-transform: uppercase; }
        .graph-legend { display: flex; gap: 12px; font-size: 0.6rem; }
        .legend-item { display: flex; align-items: center; gap: 4px; color: #52525b; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .legend-dot.target { background: var(--p-purple); }
        .legend-dot.actual { background: var(--p-blue); }
        
        .graph-container {
            height: 60px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            border-bottom: 1px solid #27272a;
            position: relative;
        }
        .graph-bar {
            flex: 1;
            min-width: 8px;
            max-width: 20px;
            background: var(--p-blue);
            border-radius: 2px 2px 0 0;
            transition: height 0.3s;
            position: relative;
        }
        .graph-bar.s-rank { background: var(--p-gold); }
        .graph-bar.a-rank { background: var(--p-blue); }
        .graph-bar.f-rank { background: var(--p-red); }
        .target-line {
            position: absolute;
            left: 0; right: 0;
            height: 2px;
            background: var(--p-purple);
            opacity: 0.6;
        }
        
        /* TIPS PANEL */
        .tips-panel {
            background: #0f0f12;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
        }
        .tips-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .tips-title { font-size: 0.7rem; color: #71717a; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .tips-toggle { color: #52525b; font-size: 0.8rem; }
        .tips-content {
            margin-top: 12px;
            display: none;
        }
        .tips-content.show { display: block; }
        .tip-item {
            padding: 8px 0;
            border-bottom: 1px solid #27272a;
            font-size: 0.75rem;
            color: #a1a1aa;
            line-height: 1.5;
        }
        .tip-item:last-child { border-bottom: none; }
        .tip-item strong { color: var(--p-blue); }
        .tip-item kbd { background: #27272a; padding: 1px 5px; border-radius: 3px; color: #fff; font-size: 0.65rem; }
        
        /* CONSISTENCY METER */
        .consistency-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
            padding: 8px 12px;
            background: #0a0a0c;
            border-radius: 6px;
            border: 1px solid #1f1f23;
        }
        .consistency-label { font-size: 0.65rem; color: #52525b; text-transform: uppercase; }
        .consistency-bar {
            flex: 1;
            height: 6px;
            background: #27272a;
            border-radius: 3px;
            overflow: hidden;
        }
        .consistency-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--p-red) 0%, var(--p-gold) 50%, var(--p-green) 100%);
            transition: width 0.3s;
            width: 0%;
        }
        .consistency-val { font-size: 0.8rem; font-weight: bold; color: #fff; min-width: 40px; text-align: right; }
        
        /* GAME MODE DROPDOWN */
        .mode-dropdown-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mode-dropdown-label {
            font-size: 0.7rem;
            color: #71717a;
            text-transform: uppercase;
            font-weight: 600;
        }
        .mode-dropdown {
            padding: 8px 12px;
            background: #1f1f23;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #fff;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            min-width: 140px;
        }
        .mode-dropdown:hover { border-color: #52525b; }
        .mode-dropdown:focus { border-color: var(--p-blue); }
        .mode-dropdown option {
            background: #18181b;
            color: #fff;
        }
        
        /* SESSION TIMER */
        .session-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 8px;
            font-size: 0.65rem;
            color: #52525b;
        }
        .session-item span { color: var(--p-green); font-weight: bold; }
        
        /* DAILY GOAL BAR */
        .daily-goal {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(63, 63, 70, 0.5);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .daily-goal-label { font-size: 0.7rem; color: #71717a; text-transform: uppercase; }
        .daily-goal-bar { flex: 1; height: 8px; background: #27272a; border-radius: 4px; overflow: hidden; }
        .daily-goal-fill { height: 100%; background: linear-gradient(90deg, var(--p-purple), var(--p-gold)); width: 0%; transition: width 0.3s; }
        .daily-goal-text { font-size: 0.8rem; font-weight: bold; color: var(--p-gold); min-width: 60px; text-align: right; }
        
        /* THEATER MODE */
        .theater-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            background: rgba(24, 24, 27, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #a1a1aa;
            font-size: 0.65rem;
            cursor: pointer;
            z-index: 100;
            transition: 0.2s;
        }
        .theater-btn:hover { background: #3f3f46; color: #fff; }
        
        body.theater-mode { background: #000; padding: 0; }
        body.theater-mode .lab-card { 
            width: 100vw; 
            height: 100vh; 
            margin: 0; 
            border-radius: 0; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
        }
        body.theater-mode .viewport { 
            width: 100vw;
            height: 80vh;
            border-radius: 0;
            margin: 0;
        }
        body.theater-mode .enemy-target { }
        body.theater-mode .combo-track { top: 55%; }
        body.theater-mode .tips-panel,
        body.theater-mode .session-info,
        body.theater-mode .perf-graph { display: none; }
        
        /* CHROMATIC ABERRATION */
        .chromatic-aberration {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 90;
            opacity: 0;
            background: 
                linear-gradient(90deg, rgba(255,0,0,0.15) 0%, transparent 15%, transparent 85%, rgba(0,255,255,0.15) 100%);
            mix-blend-mode: screen;
            animation: chromaticPulse 0.4s ease-out;
        }
        .chromatic-aberration.active { opacity: 1; }
        @keyframes chromaticPulse {
            0% { opacity: 1; filter: blur(2px); }
            100% { opacity: 0; filter: blur(0); }
        }
    </style>
</head>
<body>

    <div class="lab-card">
        <!-- DAILY GOAL -->
        <div class="daily-goal">
            <span class="daily-goal-label">Daily Goal</span>
            <div class="daily-goal-bar"><div class="daily-goal-fill" id="daily-goal-fill"></div></div>
            <span class="daily-goal-text" id="daily-goal-text">0 / 50 S-Ranks</span>
        </div>
        <h1 style="margin:0; font-size: 1.4rem; font-weight: 600; letter-spacing: 0.5px;">SHAIIKO PEEK TRAINER</h1>
        <p style="color:#52525b; margin-top:4px; font-size: 0.7rem; letter-spacing: 1px;">RHYTHM TRAINING / TIMING ANALYSIS</p>

        <!-- DIFFICULTY PRESETS -->
        <div class="difficulty-row">
            <button class="diff-btn" onclick="setDifficulty('beginner')">BEGINNER<span class="diff-bpm">80 BPM</span></button>
            <button class="diff-btn active" onclick="setDifficulty('intermediate')">INTERMEDIATE<span class="diff-bpm">120 BPM</span></button>
            <button class="diff-btn" onclick="setDifficulty('advanced')">ADVANCED<span class="diff-bpm">160 BPM</span></button>
            <button class="diff-btn" onclick="setDifficulty('shaiiko')">EXPERT<span class="diff-bpm">200 BPM</span></button>
        </div>
        
        

        <!-- BPM / RHYTHM CONTROLS -->
        <div class="rhythm-section">
            <div class="mode-dropdown-container">
                <span class="mode-dropdown-label">BPM</span>
                <select class="mode-dropdown" id="bpm-dropdown" onchange="updateBPM(parseInt(this.value))">
                    <option value="60">60</option>
                    <option value="80">80</option>
                    <option value="100">100</option>
                    <option value="120" selected>120</option>
                    <option value="140">140</option>
                    <option value="160">160</option>
                    <option value="180">180</option>
                    <option value="200">200</option>
                </select>
                <button class="metronome-toggle" id="metronome-toggle" onclick="toggleMetronome()">â™«</button>
            </div>
            <div class="mode-dropdown-container">
                <span class="mode-dropdown-label">MODE</span>
                <select class="mode-dropdown" id="mode-dropdown" onchange="setTrainingMode(this.value)">
                    <option value="full">Full Drill</option>
                    <option value="intel-only">Intel Only</option>
                    <option value="kill-only">Kill Only</option>
                    <option value="alternating">Alternating</option>
                    <option value="freeplay">Freeplay</option>
                </select>
            </div>
            <div class="beat-track">
                <div class="beat-dot" id="beat-1"></div>
                <div class="beat-dot" id="beat-2"></div>
                <div class="beat-dot" id="beat-3"></div>
                <div class="beat-dot" id="beat-4"></div>
            </div>
            <div class="target-time">
                Target: <span id="target-time">500ms</span>
            </div>
            <button class="phonk-toggle" id="phonk-toggle" onclick="togglePhonk()">ðŸŽµ PHONK</button>
            <input type="hidden" id="bpm-slider" value="120">
        </div>

        <div id="viewport" class="viewport">
            <button class="theater-btn" onclick="goFull()">â›¶ THEATER</button>
            <div class="chromatic-aberration" id="chromatic-aberration"></div>
            <div id="flash" class="flash-overlay"></div>
            <div class="mode-indicator" id="mode-indicator">RIGHT PEEK</div>
            <div class="phase-indicator intel" id="phase-indicator">PHASE 1: INTEL</div>
            
            <div class="exposure-bar-container" id="exposure-container">
                <div class="exposure-bar" id="exposure-bar"></div>
            </div>
            
            <div class="death-overlay" id="death-overlay">
                <div class="death-text" id="death-text">TRADED</div>
            </div>
            
            <div id="world" class="world-container">
                <div class="hallway">
                    <div class="floor"></div>
                    <div class="ceiling"></div>
                    <div class="wall-left"></div>
                    <div class="wall-right"></div>
                    <div class="doorframe" id="doorframe">
                        <div class="doorframe-left"></div>
                        <div class="doorframe-right"></div>
                        <div class="doorframe-top"></div>
                    </div>
                    <div class="enemy-target" id="enemy">
                        <div class="enemy-spotted-indicator">SPOTTED</div>
                        <div class="enemy-head" id="enemy-head"></div>
                        <div class="enemy-body" id="enemy-body"></div>
                    </div>
                </div>
            </div>
            
            <div class="bullet-impact" id="bullet-impact"></div>
            
            <div class="crosshair">
                <div class="crosshair-dot"></div>
                <div class="crosshair-line h left"></div>
                <div class="crosshair-line h right"></div>
                <div class="crosshair-line v top"></div>
                <div class="crosshair-line v bottom"></div>
            </div>
            
            <div class="weapon-container">
                <div id="weapon" class="weapon-model">
                    <div class="gun-body">
                        <div class="gun-barrel">
                            <div id="muzzle-flash" class="muzzle-flash"></div>
                        </div>
                        <div class="gun-optic"></div>
                        <div class="gun-grip"></div>
                        <div class="gun-mag"></div>
                    </div>
                </div>
            </div>
            
            <!-- FLOATING KEY INDICATORS -->
            <div class="combo-track">
                <div id="k0" class="key-node">-</div>
                <div id="k1" class="key-node">-</div>
                <div id="k2" class="key-node">-</div>
                <div id="k3" class="key-node">-</div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-group">
                <div class="stat-label">LAST TIME</div>
                <div id="time" class="stat-val">0ms</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">BEST TIME</div>
                <div id="best-time" class="stat-val best">-</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">AVG TIME</div>
                <div id="avg-time" class="stat-val avg">-</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">ACCURACY</div>
                <div id="accuracy" class="stat-val">0%</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">FEEDBACK</div>
                <div id="msg" class="stat-val" style="color:var(--p-gold)">READY</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">STREAK</div>
                <div id="streak" class="stat-val">0</div>
            </div>
        </div>

        <!-- TIMING BREAKDOWN - Per key timing -->
        <div class="timing-breakdown">
            <div class="split-time">
                <div class="split-label">Key 1â†’2</div>
                <div class="split-val" id="split-1">-</div>
            </div>
            <div class="split-time">
                <div class="split-label">Key 2â†’3</div>
                <div class="split-val" id="split-2">-</div>
            </div>
            <div class="split-time">
                <div class="split-label">Key 3â†’4</div>
                <div class="split-val" id="split-3">-</div>
            </div>
            <div class="split-time">
                <div class="split-label">Consistency</div>
                <div class="split-val" id="split-consistency">-</div>
            </div>
        </div>
        
        <!-- CONSISTENCY METER -->
        <div class="consistency-section">
            <span class="consistency-label">Rhythm Consistency</span>
            <div class="consistency-bar">
                <div class="consistency-fill" id="consistency-fill"></div>
            </div>
            <span class="consistency-val" id="consistency-val">0%</span>
        </div>
        
        <!-- PERFORMANCE GRAPH -->
        <div class="perf-graph">
            <div class="graph-header">
                <span class="graph-title">Last 20 Attempts</span>
                <div class="graph-legend">
                    <span class="legend-item"><span class="legend-dot target"></span> Target</span>
                    <span class="legend-item"><span class="legend-dot actual"></span> Your Time</span>
                </div>
            </div>
            <div class="graph-container" id="perf-graph">
                <div class="target-line" id="target-line" style="bottom: 50%;"></div>
            </div>
        </div>
        
        <!-- TIPS PANEL -->
        <div class="tips-panel">
            <div class="tips-header" onclick="toggleTips()">
                <span class="tips-title">PRO TIPS</span>
                <span class="tips-toggle" id="tips-toggle">â–¼</span>
            </div>
            <div class="tips-content" id="tips-content">
                <div class="tip-item"><strong>Rhythm First:</strong> Start slow (80 BPM) and focus on hitting keys exactly on beat. Speed comes naturally with consistency.</div>
                <div class="tip-item"><strong>Watch Your Splits:</strong> Check the Key 1â†’2, 2â†’3, 3â†’4 timings above. Ideally they should all be equal - that's perfect rhythm.</div>
                <div class="tip-item"><strong>Intel + Kill:</strong> In R6, you peek twice - first to spot, second to kill. This trainer simulates that. Don't skip intel phase in-game!</div>
                <div class="tip-item"><strong>Lean Timing:</strong> Press <kbd>E</kbd>/<kbd>Q</kbd> (lean) slightly BEFORE you peek. The lean should be active when your crosshair exposes.</div>
                <div class="tip-item"><strong>Counter-Strafe:</strong> The <kbd>D</kbd> after <kbd>A</kbd> (or vice versa) is your counter-strafe. It should be crisp and immediate.</div>
                <div class="tip-item"><strong>Muscle Memory:</strong> Practice 10-15 minutes daily. Short consistent sessions beat long occasional ones.</div>
                <div class="tip-item"><strong>Use Metronome:</strong> Press <kbd>M</kbd> to enable metronome. Match your keypresses to the beat for perfect timing.</div>
            </div>
        </div>
        
        <!-- SESSION INFO -->
        <div class="session-info">
            <span>Session Time: <span id="session-time">0:00</span></span>
            <span>Total Reps: <span id="total-reps">0</span></span>
            <span>S-Rank Rate: <span id="s-rank-rate">0%</span></span>
        </div>

        <button class="swap-btn" onclick="toggleMode()">[SPACE] SWAP LEFT/RIGHT PEEK</button>
        
        <div class="hotkeys">
            <span><kbd>M</kbd> Toggle Metronome</span>
            <span><kbd>â†‘/â†“</kbd> Adjust BPM</span>
            <span><kbd>R</kbd> Reset Stats</span>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SEQS = {
            'ADEQ': ['a', 'd', 'e', 'q'],
            'DAQE': ['d', 'a', 'q', 'e']
        };
        
        const TARGET_POS = {
            left: 'calc(50% - 80px)',
            right: 'calc(50% + 80px)'
        };
        
        let mode = 'ADEQ';
        let idx = 0;
        let startTime = 0;
        let streak = 0;
        
        // Two-Peek System
        let gamePhase = 'intel';
        let targetSpotted = false;
        let firedThisPeek = false;
        
        // Exposure Timer
        let exposureStart = 0;
        let exposureTimer = null;
        const MAX_EXPOSURE = 250;
        
        // Stats Tracking
        let allTimes = [];
        let successfulKills = 0;
        let totalAttempts = 0;
        let bestTime = Infinity;
        
        // BPM / Metronome
        let bpm = 120;
        let metronomeActive = false;
        let metronomeInterval = null;
        let currentBeat = 0;
        
        // Enhanced Tracking
        let keyTimes = [];
        let graphData = [];
        let sRankCount = 0;
        let trainingMode = 'full';
        let sessionStart = Date.now();
        let totalReps = 0;
        
        // ============================================
        // LERP MOVEMENT ENGINE
        // ============================================
        const movement = { currentX: 0, targetX: 0, currentLean: 0, targetLean: 0 };
        const LERP_FACTOR = 0.15;
        
        function lerp(a, b, t) { return a + (b - a) * t; }
        
        function gameLoop() {
            movement.currentX = lerp(movement.currentX, movement.targetX, LERP_FACTOR);
            movement.currentLean = lerp(movement.currentLean, movement.targetLean, LERP_FACTOR);
            
            document.getElementById('world').style.transform = `translateX(${movement.currentX}px)`;
            
            const weapon = document.getElementById('weapon');
            const rot = lerp(parseFloat(weapon.dataset.rotate || 0), movement.targetLean * 12, LERP_FACTOR);
            const shift = lerp(parseFloat(weapon.dataset.shift || 0), movement.targetLean * 20, LERP_FACTOR);
            weapon.dataset.rotate = rot;
            weapon.dataset.shift = shift;
            weapon.style.transform = `translateX(${shift}px) rotateZ(${rot}deg)`;
            
            requestAnimationFrame(gameLoop);
        }
        requestAnimationFrame(gameLoop);

        // ============================================
        // BPM / METRONOME SYSTEM
        // ============================================
        function updateBPM(newBpm) {
            bpm = newBpm;
            // Sync dropdown if value exists
            const dropdown = document.getElementById('bpm-dropdown');
            if (dropdown) dropdown.value = bpm;
            
            // Calculate target time (4 beats = full sequence)
            const beatMs = 60000 / bpm;
            const targetMs = Math.round(beatMs * 3); // 3 intervals for 4 beats
            document.getElementById('target-time').innerText = targetMs + 'ms';
            
            // Restart metronome if active
            if (metronomeActive) {
                stopMetronome();
                startMetronome();
            }
        }
        
        function toggleMetronome() {
            metronomeActive = !metronomeActive;
            const btn = document.getElementById('metronome-toggle');
            
            if (metronomeActive) {
                btn.classList.add('active');
                startMetronome();
            } else {
                btn.classList.remove('active');
                stopMetronome();
            }
        }
        
        function startMetronome() {
            const beatMs = 60000 / bpm;
            currentBeat = 0;
            
            metronomeInterval = setInterval(() => {
                // Visual beat
                for (let i = 1; i <= 4; i++) {
                    document.getElementById('beat-' + i).classList.remove('pulse');
                }
                currentBeat = (currentBeat % 4) + 1;
                document.getElementById('beat-' + currentBeat).classList.add('pulse');
                
                // Highlight corresponding key
                if (currentBeat <= 4) {
                    for (let i = 0; i < 4; i++) {
                        document.getElementById('k' + i).classList.remove('on-beat');
                    }
                    document.getElementById('k' + (currentBeat - 1)).classList.add('on-beat');
                }
                
                // Audio click
                playMetronomeClick(currentBeat === 1);
                
                // Key glow handled by on-beat class already
                
            }, beatMs);
        }
        
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            for (let i = 1; i <= 4; i++) {
                document.getElementById('beat-' + i).classList.remove('pulse');
            }
            for (let i = 0; i < 4; i++) {
                document.getElementById('k' + i).classList.remove('on-beat');
            }
        }
        
        function playMetronomeClick(accent) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(accent ? 1000 : 800, audioCtx.currentTime);
            gain.gain.setValueAtTime(accent ? 0.15 : 0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }
        
        // BPM Slider
        document.getElementById('bpm-slider').addEventListener('input', (e) => {
            updateBPM(parseInt(e.target.value));
        });

        // ============================================
        // STATS TRACKING
        // ============================================
        function updateStats(time, success) {
            totalAttempts++;
            if (success) {
                successfulKills++;
                allTimes.push(time);
                
                if (time < bestTime) {
                    bestTime = time;
                    document.getElementById('best-time').innerText = bestTime + 'ms';
                }
                
                const avg = Math.round(allTimes.reduce((a, b) => a + b, 0) / allTimes.length);
                document.getElementById('avg-time').innerText = avg + 'ms';
            }
            
            const accuracy = Math.round((successfulKills / totalAttempts) * 100);
            document.getElementById('accuracy').innerText = accuracy + '%';
        }
        
        function resetStats() {
            allTimes = [];
            successfulKills = 0;
            totalAttempts = 0;
            bestTime = Infinity;
            streak = 0;
            
            document.getElementById('best-time').innerText = '-';
            document.getElementById('avg-time').innerText = '-';
            document.getElementById('accuracy').innerText = '0%';
            document.getElementById('streak').innerText = '0';
            document.getElementById('msg').innerText = 'STATS RESET';
        }

        // ============================================
        // TARGET POSITIONING
        // ============================================
        function positionTarget() {
            const enemy = document.getElementById('enemy');
            if (mode === 'ADEQ') {
                enemy.style.left = TARGET_POS.right;
                enemy.style.marginLeft = '-14px';
            } else {
                enemy.style.left = TARGET_POS.left;
                enemy.style.marginLeft = '-14px';
            }
        }

        // ============================================
        // AUDIO ENGINE
        // ============================================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const sounds = {
                success: { type: 'sine', freq: [800, 1200], gain: 0.3, dur: 0.3 },
                click: { type: 'triangle', freq: [300], gain: 0.1, dur: 0.05 },
                fail: { type: 'square', freq: [150], gain: 0.2, dur: 0.2 },
                shot: { type: 'sawtooth', freq: [150, 50], gain: 0.4, dur: 0.15 },
                headshot: { type: 'sine', freq: [1000, 1500], gain: 0.4, dur: 0.2 },
                death: { type: 'sawtooth', freq: [100, 40], gain: 0.5, dur: 0.4 }
            };
            
            const s = sounds[type];
            osc.type = s.type;
            osc.frequency.setValueAtTime(s.freq[0], audioCtx.currentTime);
            if (s.freq[1]) osc.frequency.exponentialRampToValueAtTime(s.freq[1], audioCtx.currentTime + s.dur * 0.5);
            gain.gain.setValueAtTime(s.gain, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + s.dur);
            osc.start();
            osc.stop(audioCtx.currentTime + s.dur);
        }

        // ============================================
        // EXPOSURE TIMER
        // ============================================
        function startExposureTimer() {
            exposureStart = performance.now();
            const container = document.getElementById('exposure-container');
            const bar = document.getElementById('exposure-bar');
            container.classList.add('active');
            
            exposureTimer = setInterval(() => {
                const elapsed = performance.now() - exposureStart;
                const percent = Math.min((elapsed / MAX_EXPOSURE) * 100, 100);
                bar.style.width = percent + '%';
                
                if (elapsed >= MAX_EXPOSURE) {
                    triggerDeath('TRADED');
                }
            }, 16);
        }
        
        function stopExposureTimer() {
            if (exposureTimer) {
                clearInterval(exposureTimer);
                exposureTimer = null;
            }
            document.getElementById('exposure-container').classList.remove('active');
            document.getElementById('exposure-bar').style.width = '0%';
        }
        
        function triggerDeath(reason) {
            stopExposureTimer();
            playSound('death');
            triggerChromaticAberration();
            
            const overlay = document.getElementById('death-overlay');
            const text = document.getElementById('death-text');
            text.innerText = reason;
            overlay.classList.add('active');
            
            document.getElementById('viewport').classList.add('death-flash');
            
            updateStats(0, false);
            streak = 0;
            document.getElementById('streak').innerText = 0;
            document.getElementById('msg').innerText = reason;
            
            setTimeout(() => {
                overlay.classList.remove('active');
                document.getElementById('viewport').classList.remove('death-flash');
                fullReset();
            }, 800);
        }

        // ============================================
        // SHOT REGISTRATION
        // ============================================
        function checkHit() {
            const head = document.getElementById('enemy-head');
            const impact = document.getElementById('bullet-impact');
            const viewport = document.getElementById('viewport');
            const vRect = viewport.getBoundingClientRect();
            const headRect = head.getBoundingClientRect();
            
            const hitZone = 'KILL';
            const score = 100;
            
            const impactX = headRect.left - vRect.left + headRect.width / 2;
            const impactY = headRect.top - vRect.top + headRect.height / 2;
            
            playSound('headshot');
            
            impact.style.left = impactX + 'px';
            impact.style.top = impactY + 'px';
            impact.classList.add('visible');
            setTimeout(() => impact.classList.remove('visible'), 500);
            
            return { hitZone, score };
        }

        // ============================================
        // VISUAL FEEDBACK
        // ============================================
        function triggerMuzzleFlash() {
            const flash = document.getElementById('muzzle-flash');
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 80);
        }
        
        function triggerScreenShake() {
            document.getElementById('viewport').classList.add('shake');
            setTimeout(() => document.getElementById('viewport').classList.remove('shake'), 50);
        }
        
        function recoilKick() {
            const crosshair = document.querySelector('.crosshair');
            crosshair.classList.remove('recoil');
            void crosshair.offsetWidth;
            crosshair.classList.add('recoil');
            setTimeout(() => crosshair.classList.remove('recoil'), 40);
        }
        
        function updateMovement() {
            const patterns = {
                'ADEQ': [{ x: 80, lean: 0 }, { x: -60, lean: 0 }, { x: -80, lean: 1 }, { x: -40, lean: -0.3 }],
                'DAQE': [{ x: -80, lean: 0 }, { x: 60, lean: 0 }, { x: 80, lean: -1 }, { x: 40, lean: 0.3 }]
            };
            if (idx <= 3) {
                const p = patterns[mode][idx];
                movement.targetX = p.x;
                movement.targetLean = p.lean;
            }
        }
        
        function updatePhaseUI() {
            const phaseEl = document.getElementById('phase-indicator');
            if (gamePhase === 'intel') {
                phaseEl.innerText = 'PHASE 1: INTEL';
                phaseEl.className = 'phase-indicator intel';
            } else {
                phaseEl.innerText = 'PHASE 2: KILL';
                phaseEl.className = 'phase-indicator kill';
            }
        }

        // ============================================
        // CORE GAME LOGIC
        // ============================================
        function init() {
            const keys = SEQS[mode];
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('k'+i);
                el.textContent = keys[i].toUpperCase();
                el.className = 'key-node';
            }
            document.getElementById('k0').classList.add('active');
            document.getElementById('msg').innerText = gamePhase === 'intel' ? 'GATHER INTEL' : 'EXECUTE';
            document.getElementById('mode-indicator').innerText = mode === 'ADEQ' ? 'RIGHT PEEK' : 'LEFT PEEK';
            
            positionTarget();
            
            const enemy = document.getElementById('enemy');
            enemy.classList.remove('hidden', 'dead');
            if (targetSpotted) enemy.classList.add('spotted');
            
            movement.targetX = 0;
            movement.targetLean = 0;
            firedThisPeek = false;
            
            updatePhaseUI();
        }

        document.getElementById('viewport').addEventListener('contextmenu', (e) => e.preventDefault());
        
        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            
            if (k === ' ') { e.preventDefault(); toggleMode(); return; }
            if (k === 'm') { toggleMetronome(); return; }
            if (k === 'r') { resetStats(); return; }
            if (k === 'arrowup') { updateBPM(Math.min(200, bpm + 20)); return; }
            if (k === 'arrowdown') { updateBPM(Math.max(60, bpm - 20)); return; }

            const targetKey = SEQS[mode][idx];
            
            if (k === targetKey) {
                if (idx === 0) {
                    startTime = performance.now();
                    resetKeyTimes();
                }
                recordKeyTime();
                playSound('click');
                
                document.getElementById('k'+idx).classList.remove('active');
                document.getElementById('k'+idx).classList.add('hit');

                idx++;
                updateMovement();
                

                
                if (idx < 4) {
                    document.getElementById('k'+idx).classList.add('active');
                } else {
                    const totalTime = (performance.now() - startTime).toFixed(0);
                    finishSequence(totalTime, false);
                }

            } else if (['a','d','e','q'].includes(k)) {
                fail();
            }
        });
        
        
        function finishSequence(ms) {
            stopExposureTimer();
            document.getElementById('time').innerText = ms + 'ms';
            
            if (gamePhase === 'intel') {
                // Intel phase complete - spot target
                targetSpotted = true;
                document.getElementById('enemy').classList.add('spotted');
                document.getElementById('msg').innerText = 'TARGET SPOTTED';
                playSound('success');
                
                // Calculate splits for intel phase too
                totalReps++;
                calculateSplits();
                updateGraph(parseInt(ms), 'A');
                
                if (trainingMode === 'intel-only') {
                    // Stay in intel mode
                    fullReset();
                } else {
                    // Instant transition to kill phase
                    gamePhase = 'kill';
                    reset();
                }
                
            } else if (gamePhase === 'kill') {
                // Kill phase - AUTO FIRE on sequence complete
                triggerMuzzleFlash();
                triggerScreenShake();
                recoilKick();
                document.getElementById('k3').classList.add('fire');
                
                const { hitZone, score } = checkHit();
                finishKill(parseInt(ms), hitZone, score);
            }
        }
        
        function finishKill(ms, hitZone, score) {
            document.getElementById('time').innerText = ms + 'ms';
            
            const flash = document.getElementById('flash');
            const targetMs = Math.round((60000 / bpm) * 3);
            
            let rank = 'D';
            
            // Compare against BPM target time
            if (ms <= targetMs * 0.8 || trainingMode === 'freeplay') {
                rank = 'S';
                streak++;
                sRankCount++;
                updateDailyGoal();
                flash.style.background = '#ffcc00';
                document.getElementById('msg').innerText = trainingMode === 'freeplay' ? ms + 'ms' : 'GODLIKE';
                // JUICE: Shake on S-rank
                const vp = document.getElementById('viewport');
                vp.classList.remove('juice-shake');
                void vp.offsetWidth; // Force reflow
                vp.classList.add('juice-shake');
                setTimeout(() => vp.classList.remove('juice-shake'), 150);
                document.getElementById('enemy').classList.add('dead');
                updateStats(ms, true);
            } else if (ms <= targetMs) {
                rank = 'A';
                streak++;
                flash.style.background = '#00d4ff';
                document.getElementById('msg').innerText = 'ON BEAT';
                document.getElementById('enemy').classList.add('dead');
                updateStats(ms, true);
            } else {
                rank = 'F';
                streak = 0;
                flash.style.background = '#ff4b4b';
                document.getElementById('msg').innerText = 'OFF BEAT';
                document.getElementById('enemy').classList.add('dead');
                updateStats(ms, false);
            }

            // Rank shown in feedback stat
            document.getElementById('streak').innerText = streak;
            
            // Update training analytics
            totalReps++;
            calculateSplits();
            updateGraph(ms, rank);
            
            flash.style.opacity = '0.15';
            setTimeout(() => document.getElementById('flash').style.opacity = '0', 20);
            
            // Instant reset to next round
            fullReset();
        }

        function fail() {
            stopExposureTimer();
            playSound('fail');
            // JUICE: Chromatic on fail
            const vp = document.getElementById('viewport');
            vp.classList.remove('chromatic');
            void vp.offsetWidth; // Force reflow
            vp.classList.add('chromatic');
            setTimeout(() => vp.classList.remove('chromatic'), 300);
            updateStats(0, false);
            streak = 0;
            document.getElementById('streak').innerText = 0;
            document.getElementById('msg').innerText = 'MISCLICK';
            document.getElementById('flash').style.background = '#ff4b4b';
            document.getElementById('flash').style.opacity = '0.3';
            setTimeout(() => document.getElementById('flash').style.opacity = '0', 100);
            
            // Instant reset
            reset();
        }

        function reset() {
            idx = 0;
            init();
            document.getElementById('flash').style.opacity = '0';
        }
        
        function fullReset() {
            // Handle training modes
            if (trainingMode === 'kill-only' || trainingMode === 'freeplay') {
                gamePhase = 'kill';
                targetSpotted = true;
            } else if (trainingMode === 'intel-only') {
                gamePhase = 'intel';
                targetSpotted = false;
            } else if (trainingMode === 'alternating') {
                mode = mode === 'ADEQ' ? 'DAQE' : 'ADEQ';
                gamePhase = 'intel';
                targetSpotted = false;
            } else {
                gamePhase = 'intel';
                targetSpotted = false;
            }
            firedThisPeek = false;
            reset();
        }

        function toggleMode() {
            mode = mode === 'ADEQ' ? 'DAQE' : 'ADEQ';
            streak = 0;
            document.getElementById('streak').innerText = 0;
            fullReset();
        }

        // ============================================
        // DIFFICULTY PRESETS
        // ============================================
        function setDifficulty(level) {
            const presets = {
                'beginner': 80,
                'intermediate': 120,
                'advanced': 160,
                'shaiiko': 200
            };
            
            document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.diff-btn').classList.add('active');
            
            updateBPM(presets[level]);
            document.getElementById('bpm-dropdown').value = presets[level];
        }
        
        // ============================================
        // TRAINING MODES
        // ============================================
        function setTrainingMode(newMode) {
            trainingMode = newMode;
            document.getElementById('mode-dropdown').value = newMode;
            
            // Reset to appropriate phase
            if (newMode === 'intel-only') {
                gamePhase = 'intel';
            } else if (newMode === 'kill-only' || newMode === 'freeplay') {
                gamePhase = 'kill';
                targetSpotted = true;
            } else {
                gamePhase = 'intel';
            }
            reset();
        }
        
        // ============================================
        // PER-KEY TIMING TRACKING
        // ============================================
        function recordKeyTime() {
            keyTimes.push(performance.now());
        }
        
        function calculateSplits() {
            if (keyTimes.length < 4) return;
            
            const splits = [];
            for (let i = 1; i < keyTimes.length; i++) {
                splits.push(Math.round(keyTimes[i] - keyTimes[i-1]));
            }
            
            // Display splits
            for (let i = 0; i < 3; i++) {
                const el = document.getElementById('split-' + (i + 1));
                const targetSplit = Math.round((60000 / bpm));
                const diff = splits[i] - targetSplit;
                
                el.innerText = splits[i] + 'ms';
                el.className = 'split-val';
                
                if (Math.abs(diff) < targetSplit * 0.15) {
                    el.classList.add('fast');
                } else if (Math.abs(diff) < targetSplit * 0.3) {
                    el.classList.add('ok');
                } else {
                    el.classList.add('slow');
                }
            }
            
            // Calculate consistency (lower variance = better)
            const avg = splits.reduce((a, b) => a + b, 0) / splits.length;
            const variance = splits.reduce((sum, s) => sum + Math.pow(s - avg, 2), 0) / splits.length;
            const stdDev = Math.sqrt(variance);
            const consistencyScore = Math.max(0, Math.min(100, 100 - (stdDev / avg * 100)));
            
            document.getElementById('split-consistency').innerText = Math.round(consistencyScore) + '%';
            document.getElementById('split-consistency').className = 'split-val ' + (consistencyScore > 80 ? 'fast' : consistencyScore > 50 ? 'ok' : 'slow');
            
            // Update consistency meter
            document.getElementById('consistency-fill').style.width = consistencyScore + '%';
            document.getElementById('consistency-val').innerText = Math.round(consistencyScore) + '%';
        }
        
        function resetKeyTimes() {
            keyTimes = [];
        }
        
        // ============================================
        // PERFORMANCE GRAPH
        // ============================================
        function updateGraph(time, rank) {
            graphData.push({ time, rank });
            if (graphData.length > 20) graphData.shift();
            
            const container = document.getElementById('perf-graph');
            const targetMs = Math.round((60000 / bpm) * 3);
            const maxTime = Math.max(targetMs * 1.5, ...graphData.map(d => d.time));
            
            // Clear old bars (keep target line)
            container.querySelectorAll('.graph-bar').forEach(b => b.remove());
            
            // Add new bars
            graphData.forEach((d, i) => {
                const bar = document.createElement('div');
                bar.className = 'graph-bar ' + d.rank.toLowerCase() + '-rank';
                bar.style.height = (d.time / maxTime * 100) + '%';
                bar.title = d.time + 'ms';
                container.appendChild(bar);
            });
            
            // Update target line position
            document.getElementById('target-line').style.bottom = (targetMs / maxTime * 100) + '%';
        }
        
        // ============================================
        // SESSION TRACKING
        // ============================================
        function updateSessionStats() {
            const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('session-time').innerText = mins + ':' + (secs < 10 ? '0' : '') + secs;
            document.getElementById('total-reps').innerText = totalReps;
            
            const sRate = totalReps > 0 ? Math.round((sRankCount / totalReps) * 100) : 0;
            document.getElementById('s-rank-rate').innerText = sRate + '%';
        }
        
        setInterval(updateSessionStats, 1000);
        
        // ============================================
        // TIPS PANEL
        // ============================================
        function toggleTips() {
            const content = document.getElementById('tips-content');
            const toggle = document.getElementById('tips-toggle');
            content.classList.toggle('show');
            toggle.innerText = content.classList.contains('show') ? 'â–²' : 'â–¼';
        }

        // ============================================
        // PHONK BEAT SYSTEM
        // ============================================
        let phonkActive = false;
        let phonkAudio = null;
        let phonkBeatInterval = null;
        
        function togglePhonk() {
            phonkActive = !phonkActive;
            const btn = document.getElementById('phonk-toggle');
            
            if (phonkActive) {
                btn.classList.add('active');
                btn.innerText = 'ðŸŽµ PHONK ON';
                startPhonkBeat();
            } else {
                btn.classList.remove('active');
                btn.innerText = 'ðŸŽµ PHONK';
                stopPhonkBeat();
            }
        }
        
        // BPM Playlist
        const PHONK_TRACKS = {
            slow: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
            mid: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
            fast: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3'
        };
        
        function getTrackForBPM(currentBpm) {
            if (currentBpm <= 90) return PHONK_TRACKS.slow;
            if (currentBpm <= 140) return PHONK_TRACKS.mid;
            return PHONK_TRACKS.fast;
        }
        
        function startPhonkBeat() {
            const trackUrl = getTrackForBPM(bpm);
            if (!phonkAudio || phonkAudio.src !== trackUrl) {
                if (phonkAudio) phonkAudio.pause();
                phonkAudio = new Audio(trackUrl);
                phonkAudio.loop = true;
                phonkAudio.volume = 0.3;
            }
            phonkAudio.play().catch(e => console.log('Audio autoplay blocked'));
            
            const beatMs = 60000 / bpm;
            let beatCount = 0;
            phonkBeatInterval = setInterval(() => {
                beatCount = (beatCount % 4) + 1;
                for (let i = 1; i <= 4; i++) document.getElementById('beat-' + i).classList.remove('pulse');
                document.getElementById('beat-' + beatCount).classList.add('pulse');
                for (let i = 0; i < 4; i++) document.getElementById('k' + i).classList.remove('on-beat');
                document.getElementById('k' + (beatCount - 1)).classList.add('on-beat');
                document.getElementById('viewport').classList.add('beat-flash');
                setTimeout(() => document.getElementById('viewport').classList.remove('beat-flash'), 100);
            }, beatMs);
        }
        
        function stopPhonkBeat() {
            if (phonkAudio) {
                phonkAudio.pause();
                phonkAudio.currentTime = 0;
            }
            if (phonkBeatInterval) {
                clearInterval(phonkBeatInterval);
                phonkBeatInterval = null;
            }
            // Clear beat indicators
            for (let i = 1; i <= 4; i++) {
                document.getElementById('beat-' + i).classList.remove('pulse');
            }
            for (let i = 0; i < 4; i++) {
                document.getElementById('k' + i).classList.remove('on-beat');
            }
        }

        // ============================================
        // FULLSCREEN / THEATER MODE
        // ============================================
        function goFull() {
            console.log("Fullscreen triggered");
            let elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen(); }
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
            else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
        }
        
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                document.body.classList.add('theater-mode');
            } else {
                document.body.classList.remove('theater-mode');
            }
        });
        
        // ============================================
        // CHROMATIC ABERRATION EFFECT
        // ============================================
        function triggerChromaticAberration() {
            const el = document.getElementById('chromatic-aberration');
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), 400);
        }
        
        // ============================================
        // DAILY GOAL TRACKING
        // ============================================
        const DAILY_GOAL = 50;
        function updateDailyGoal() {
            const percent = Math.min((sRankCount / DAILY_GOAL) * 100, 100);
            document.getElementById('daily-goal-fill').style.width = percent + '%';
            document.getElementById('daily-goal-text').innerText = sRankCount + ' / ' + DAILY_GOAL + ' S-Ranks';
        }
        
        // Initialize
        updateBPM(120);
        init();
    </script>
</body>
</html>
