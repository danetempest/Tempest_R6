<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>R6 Recoil Lab - Pro</title>
    <style>
        :root {
            --bg: #09090b;
            --accent: #ef4444; 
            --text: #f4f4f5;
            --target-active: #22c55e; /* Green */
            --target-dead: #52525b;   /* Grey */
        }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            user-select: none;
        }

        .home-btn {
            position: absolute; top: 20px; left: 20px;
            background: #27272a; color: #a1a1aa; text-decoration: none;
            padding: 10px 20px; border-radius: 6px; border: 1px solid #3f3f46;
            font-weight: 700; font-size: 0.8rem; transition: 0.2s;
            z-index: 100;
        }
        .home-btn:hover { border-color: #fff; color: #fff; }

        #game-area {
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.5);
            border: 2px solid #333;
            border-radius: 12px;
            cursor: none; 
            background: radial-gradient(circle at center, #18181b 0%, #000 100%);
        }

        /* HUD */
        #hud {
            position: absolute; top: 20px; width: 100%;
            display: flex; justify-content: center; gap: 20px; pointer-events: none;
        }
        .stat-box {
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 8px; border: 1px solid #333;
            min-width: 120px; text-align: center;
        }
        .label { font-size: 0.7rem; color: #a1a1aa; text-transform: uppercase; margin-bottom: 5px; }
        .value { font-size: 1.5rem; font-weight: 800; color: #fff; font-variant-numeric: tabular-nums; }
        #score-disp { color: var(--accent); }

        /* RECOIL BAR */
        #recoil-bar-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;
        }
        #recoil-fill {
            height: 100%; width: 0%; background: var(--accent);
            transition: width 0.1s linear;
        }

        /* START SCREEN */
        #overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(9, 9, 11, 0.95);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 10; border-radius: 12px;
        }
        
        h1 { font-size: 3rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); }
        .big-count { font-size: 8rem; font-weight: 900; color: #fff; animation: popIn 0.5s ease-out; }
        
        /* MODE SELECTOR */
        .mode-select {
            margin: 20px 0;
            background: #000; color: #fff;
            border: 1px solid #444; padding: 10px 20px;
            font-size: 1.2rem; border-radius: 6px; cursor: pointer;
            font-family: 'Segoe UI', sans-serif; font-weight: 700;
        }

        .btn {
            background: var(--accent); color: #fff; border: none;
            padding: 15px 40px; font-size: 1.2rem; font-weight: 800;
            cursor: pointer; border-radius: 6px; 
            transition: 0.2s; border: 1px solid #b91c1c;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--accent); }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <a href="index.html" class="home-btn">‚Üê DASHBOARD</a>

    <div id="game-area">
        <canvas id="recoilCanvas" width="800" height="600"></canvas>
        
        <div id="hud">
            <div class="stat-box">
                <div class="label">Time / Score</div>
                <div class="value" id="score-disp">0.00</div>
            </div>
            <div class="stat-box">
                <div class="label">Status</div>
                <div class="value" id="status-disp">HOLD</div>
            </div>
        </div>

        <div id="recoil-bar-container">
            <div id="recoil-fill"></div>
        </div>

        <div id="overlay-screen">
            <h1>Recoil Lab</h1>
            
            <div style="margin-top:20px; text-align:center;">
                <label style="color:#aaa; font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">Select Drill Mode</label><br>
                <select id="mode-select" class="mode-select">
                    <option value="classic">CLASSIC (Static Hold)</option>
                    <option value="flick">FLICK & HOLD (Moving Target)</option>
                    <option value="transfer">SPRAY TRANSFER (Multi-Target)</option>
                </select>
            </div>

            <p style="color:#a1a1aa; margin-bottom:30px;">Keep the Red Dot inside the circle.<br>It pulls UP automatically.</p>
            <button class="btn" onclick="triggerCountdown()">START DRILL</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('recoilCanvas');
        const ctx = canvas.getContext('2d');
        const overlayScreen = document.getElementById('overlay-screen');
        const scoreDisp = document.getElementById('score-disp');
        const statusDisp = document.getElementById('status-disp');
        const recoilFill = document.getElementById('recoil-fill');
        const modeSelect = document.getElementById('mode-select');

        // Game State
        let isRunning = false;
        let startTime = 0;
        let animationFrame;
        let gameMode = 'classic';
        
        // Physics
        let ballX = 400; 
        let ballY = 300; 
        let recoilForce = 0; 
        
        // Target Logic
        let targets = []; // Array of active targets {x, y, active, hp}
        let activeTargetIndex = 0;
        let lastFlickTime = 0;

        // Config
        const ZONE_RADIUS = 50; // Slightly tighter for pro training
        const BALL_RADIUS = 6; 

        canvas.requestPointerLock = canvas.requestPointerLock || canvas.mozRequestPointerLock;

        function triggerCountdown() {
            gameMode = modeSelect.value;
            canvas.requestPointerLock();
            
            let count = 3;
            overlayScreen.innerHTML = `<div class="big-count">${count}</div>`;
            
            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    overlayScreen.innerHTML = `<div class="big-count">${count}</div>`;
                } else {
                    clearInterval(countInterval);
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            overlayScreen.style.display = 'none';
            
            // Reset Physics
            ballX = 400;
            ballY = 300;
            recoilForce = 1.0;
            startTime = Date.now();
            isRunning = true;
            lastFlickTime = Date.now();

            // Initialize Targets based on Mode
            targets = [];
            if (gameMode === 'classic') {
                targets.push({ x: 400, y: 300, active: true, hp: 100 });
            } 
            else if (gameMode === 'flick') {
                targets.push({ x: 400, y: 300, active: true, hp: 100 });
            } 
            else if (gameMode === 'transfer') {
                // Spawn 2 targets initially
                spawnMultiTarget(true); // Active
                spawnMultiTarget(false); // Inactive
            }

            document.addEventListener("mousemove", handleMouse, false);
            document.addEventListener("pointerlockchange", lockChangeAlert, false);
            gameLoop();
        }

        function spawnMultiTarget(isActive) {
            // Random position but keep away from edges
            const x = Math.random() * (700 - 100) + 100;
            const y = Math.random() * (500 - 100) + 100;
            targets.push({ x: x, y: y, active: isActive, hp: 100, maxHp: 100 });
        }

        function lockChangeAlert() {
            if (document.pointerLockElement !== canvas && isRunning) gameOver("PAUSED");
        }

        function handleMouse(e) {
            if (!isRunning) return;
            ballY += e.movementY; 
            ballX += e.movementX;
        }

        function gameLoop() {
            if (!isRunning) return;

            let now = Date.now();
            let elapsed = (now - startTime) / 1000;

            // --- 1. MODE LOGIC ---
            
            if (gameMode === 'classic') {
                // Simple difficulty ramp
                recoilForce = 1.0 + (elapsed * 0.05); 
                statusDisp.innerText = "HOLD";
            } 
            
            else if (gameMode === 'flick') {
                recoilForce = 1.2 + (elapsed * 0.02);
                
                // Move target every 4 seconds
                if (now - lastFlickTime > 4000) {
                    targets[0].x = Math.random() * (600 - 200) + 200;
                    targets[0].y = Math.random() * (450 - 150) + 150;
                    lastFlickTime = now;
                    statusDisp.innerText = "FLICK!";
                    statusDisp.style.color = "#eab308"; // Yellow alert
                } else {
                    statusDisp.innerText = "HOLD";
                    statusDisp.style.color = "#fff";
                }
            } 
            
            else if (gameMode === 'transfer') {
                recoilForce = 1.5; // Constant pressure
                
                // Find the active target
                let activeT = targets.find(t => t.active);
                
                // Check if player is inside the active target
                let dist = Math.hypot(ballX - activeT.x, ballY - activeT.y);
                
                if (dist < ZONE_RADIUS) {
                    // Draining HP (Killing the target)
                    activeT.hp -= 2; 
                    statusDisp.innerText = "KILLING...";
                    statusDisp.style.color = "#22c55e";
                } else {
                    statusDisp.innerText = "MISSING";
                    statusDisp.style.color = "#ef4444";
                }

                // Target Dead?
                if (activeT.hp <= 0) {
                    // Switch active to the other one
                    targets = targets.filter(t => t !== activeT); // Remove dead
                    if (targets.length > 0) {
                        targets[0].active = true; // Activate next
                    }
                    // Spawn a new inactive one
                    spawnMultiTarget(false);
                }
            }

            // --- 2. PHYSICS ---
            let jitter = (Math.random() - 0.5) * (recoilForce * 1.5);
            ballY -= recoilForce; 
            ballX += jitter;

            // --- 3. CHECK FAILURE ---
            // In flick/classic, if you leave the circle you die.
            // In transfer, you don't die from position, only if you run out of canvas (too high/low)
            
            if (gameMode !== 'transfer') {
                let currentTarget = targets[0];
                let dist = Math.hypot(ballX - currentTarget.x, ballY - currentTarget.y);
                if (dist > ZONE_RADIUS) {
                    gameOver("LOST CONTROL");
                    return;
                }
            }

            // General Bounds Check (Don't let ball fly off screen)
            if (ballY < 0 || ballY > 600 || ballX < 0 || ballX > 800) {
                gameOver("OFF SCREEN");
                return;
            }

            // UI Updates
            scoreDisp.innerText = elapsed.toFixed(2) + "s";
            let visualRecoil = Math.min(100, (recoilForce / 4) * 100);
            recoilFill.style.width = visualRecoil + "%";

            draw();
            animationFrame = requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Targets
            targets.forEach(t => {
                ctx.beginPath();
                ctx.arc(t.x, t.y, ZONE_RADIUS, 0, Math.PI * 2);
                
                if (t.active) {
                    ctx.strokeStyle = "#22c55e"; // Green for Active
                    ctx.lineWidth = 4;
                    // Draw HP fill for active
                    ctx.fillStyle = "rgba(34, 197, 94, 0.2)";
                    ctx.fill();
                } else {
                    ctx.strokeStyle = "#52525b"; // Grey for Inactive
                    ctx.lineWidth = 2;
                }
                ctx.stroke();
                
                // Draw HP Ring for Transfer Mode
                if (gameMode === 'transfer' && t.active) {
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, ZONE_RADIUS - 5, 0, (Math.PI * 2) * (t.hp / 100));
                    ctx.strokeStyle = "#fff";
                    ctx.stroke();
                }
            });

            // Player Dot
            ctx.beginPath();
            ctx.arc(ballX, ballY, BALL_RADIUS, 0, Math.PI * 2);
            ctx.fillStyle = "#ef4444"; 
            ctx.fill();
            
            // Tension Line (Connect ball to active target center)
            let activeT = targets.find(t => t.active) || targets[0];
            if (activeT) {
                ctx.beginPath();
                ctx.moveTo(activeT.x, activeT.y);
                ctx.lineTo(ballX, ballY);
                ctx.strokeStyle = "rgba(239, 68, 68, 0.3)";
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        function gameOver(reason) {
            isRunning = false;
            document.exitPointerLock();
            document.removeEventListener("mousemove", handleMouse, false);
            cancelAnimationFrame(animationFrame);

            // Rebuild Overlay
            overlayScreen.style.display = 'flex';
            
            // Recreate standard layout
            overlayScreen.innerHTML = `
                <h1 style="color:#ef4444">${reason}</h1>
                <p>Time Alive: <strong style="color:white; font-size:1.5rem;">${scoreDisp.innerText}</strong></p>
                
                <div style="margin-top:20px; text-align:center;">
                    <label style="color:#aaa; font-size:0.8rem;">MODE SELECTION</label><br>
                    <select id="mode-select-end" class="mode-select">
                        <option value="classic" ${gameMode === 'classic' ? 'selected' : ''}>CLASSIC</option>
                        <option value="flick" ${gameMode === 'flick' ? 'selected' : ''}>FLICK & HOLD</option>
                        <option value="transfer" ${gameMode === 'transfer' ? 'selected' : ''}>SPRAY TRANSFER</option>
                    </select>
                </div>

                <button class="btn" onclick="retryFromEnd()">RETRY</button>
            `;
        }

        function retryFromEnd() {
            // Update mode from the Game Over screen selection
            const endSelect = document.getElementById('mode-select-end');
            modeSelect.value = endSelect.value; 
            triggerCountdown();
        }
    </script>
</body>
</html>
